<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <title>Form Kalibrasi Timbangan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-white text-black text-[12px] p-0 m-0">
  <div class="w-[1200px] mx-auto py-8 px-4 relative min-h-screen">
    <!-- ACTIONS -->
    <div class="flex justify-between items-center mb-8 no-print border-b pb-4">
      <div class="flex gap-3">
        <button onclick="toleransiKalibrasi()"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded shadow transition-all active:scale-95">Toleransi
          Kalibrasi</button>
        <a href="masterBatuTimbang.html"
          class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded shadow transition-all active:scale-95">Master
          Data</a>
        <button onclick="openMPEModal()"
          class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded shadow transition-all active:scale-95">Tabel
          MPE</button>
      </div>
      <button onclick="exportToPDF()"
        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded shadow transition-all active:scale-95 flex items-center gap-2">
        <span>Cetak ke PDF</span>
      </button>
    </div>

    <!-- MAIN HEADER -->
    <h1 class="text-center font-bold text-xl mb-8 uppercase tracking-widest underline decoration-double">
      Form Kalibrasi Timbangan
    </h1>

    <!-- 1. IDENTITAS ALAT -->
    <section class="mb-8">
      <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
        <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">1</span>
        IDENTITAS ALAT
      </h2>
      <table class="w-full border border-black border-collapse table-fixed">
        <tr>
          <td class="border border-black px-4 py-2 font-bold w-[250px] bg-gray-100">No. Sertifikat Kalibrasi</td>
          <td class="border border-black w-[30px] text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">
            <input type="text" id="cert-no" class="w-full border-0 focus:outline-none focus:ring-0 p-0 bg-transparent"
              placeholder="QASS-QC/O/TMB/XXXX/XXX" />
          </td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">Merk / Type / SN</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">AND / EK-1200i / P1850111</td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">Kapasitas / Daya Baca / e</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td id="specs-cell-container" class="border border-black px-4 py-2 flex items-center justify-between">
            <div id="specs-input-group" class="flex items-center gap-1 flex-1">
              <input type="text" id="input-cap"
                class="w-16 border-b border-dashed border-gray-300 focus:border-blue-500 focus:outline-none text-center bg-transparent"
                placeholder="0" oninput="saveSpecs()" />
              <span class="unit-label">g</span>
              <span class="mx-1">/</span>
              <input type="text" id="input-d"
                class="w-16 border-b border-dashed border-gray-300 focus:border-blue-500 focus:outline-none text-center bg-transparent"
                placeholder="0" oninput="saveSpecs()" />
              <span class="unit-label">g</span>
              <span class="mx-1">/</span>
              <input type="text" id="input-e"
                class="w-12 border-b border-dashed border-gray-300 focus:border-blue-500 focus:outline-none text-center bg-transparent"
                placeholder="0" oninput="saveSpecs()" />
              <span class="unit-label">g</span>
              <span id="specs-cell" class="hidden"></span>
            </div>
            <select id="unit-selector" onchange="handleUnitChange(this.value)"
              class="ml-4 border border-gray-300 rounded px-2 py-1 bg-white text-xs no-print focus:outline-none focus:ring-1 focus:ring-blue-500">
              <option value="g">gram (g)</option>
              <option value="kg">kilogram (kg)</option>
              <option value="mg">miligram (mg)</option>
            </select>
          </td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">No Identitas</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2 relative">
            <input type="text" id="no-identitas"
              class="w-full border-0 focus:outline-none focus:ring-0 p-0 bg-transparent" placeholder="QC/O/TMB/XXXX/XXX"
              onkeyup="showSuggestions(this.value)" />
            <div id="suggestions-box"
              class="absolute hidden bg-white border border-gray-300 shadow-xl z-10 w-full max-h-40 overflow-y-auto left-0 top-full">
            </div>
          </td>
        </tr>
        <script>
          const identitasOptions = [
            "QC/O/TMB/2013/018",
            "QC/O/TMB/2024/029",
            "QC/O/TMB/2025/030",
            // ... data lainnya
          ];

          function showSuggestions(value) {
            const box = document.getElementById("suggestions-box");
            const input = document.getElementById("no-identitas");

            if (value.length < 2) {
              box.classList.add("hidden");
              return;
            }

            const filtered = identitasOptions
              .filter((opt) => opt.toLowerCase().includes(value.toLowerCase()))
              .slice(0, 5); // Hanya tampilkan 5 suggestion maksimal

            if (filtered.length === 0) {
              box.classList.add("hidden");
              return;
            }

            box.innerHTML = filtered
              .map(
                (opt) => `
      <div class="px-3 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
           onclick="selectSuggestion('${opt}')">
        ${opt}
      </div>
    `
              )
              .join("");

            box.classList.remove("hidden");
          }

          function selectSuggestion(value) {
            document.getElementById("no-identitas").value = value;
            document.getElementById("suggestions-box").classList.add("hidden");
          }

          // Tutup suggestion box ketika klik di luar
          document.addEventListener("click", (e) => {
            if (
              !e.target.closest("#no-identitas") &&
              !e.target.closest("#suggestions-box")
            ) {
              document
                .getElementById("suggestions-box")
                .classList.add("hidden");
            }
          });
        </script>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">Lokasi</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">R. Timbang / QC Obat (Gedung A)</td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">Tanggal Kalibrasi</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">
            <input type="date" id="cal-date"
              class="w-full border-0 focus:outline-none focus:ring-0 p-0 bg-transparent" />
          </td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">Interval Kalibrasi</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">12 Bulan</td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">Suhu / RH / Pa</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">
            <div class="flex items-center justify-start gap-4">
              <div class="flex items-center gap-1">
                <input type="text" id="env-suhu"
                  class="w-12 border-b border-gray-300 focus:border-blue-500 focus:outline-none p-0 bg-transparent text-center"
                  placeholder="0" />
                <span>¬∞C</span>
              </div>
              <span class="text-gray-400">/</span>
              <div class="flex items-center gap-1">
                <input type="text" id="env-rh"
                  class="w-12 border-b border-gray-300 focus:border-blue-500 focus:outline-none p-0 bg-transparent text-center"
                  placeholder="0" />
                <span>%</span>
              </div>
              <span class="text-gray-400">/</span>
              <div class="flex items-center gap-1">
                <input type="text" id="env-pa"
                  class="w-16 border-b border-gray-300 focus:border-blue-500 focus:outline-none p-0 bg-transparent text-center"
                  placeholder="0" />
                <span>hPa</span>
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">No. Formulir</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">
            <input type="text" id="form-no" value="QASS-F-004" readonly
              class="w-full border-0 focus:outline-none focus:ring-0 p-0 bg-gray-100 cursor-not-allowed text-gray-700"
              ondblclick="handleMetaEdit(this)" onblur="handleMetaEdit(this, true)" title="Double click to edit" />
          </td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">Revisi</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">
            <input type="text" id="rev-no" value="00" readonly
              class="w-full border-0 focus:outline-none focus:ring-0 p-0 bg-gray-100 cursor-not-allowed text-gray-700"
              ondblclick="handleMetaEdit(this)" onblur="handleMetaEdit(this, true)" title="Double click to edit" />
          </td>
        </tr>
        <tr>
          <td class="border border-black px-4 py-2 font-bold bg-gray-100">Tanggal Berlaku</td>
          <td class="border border-black text-center bg-gray-50">:</td>
          <td class="border border-black px-4 py-2">
            <input type="text" id="eff-date" value="01 Januari 2024" readonly
              class="w-full border-0 focus:outline-none focus:ring-0 p-0 bg-gray-100 cursor-not-allowed text-gray-700"
              ondblclick="handleMetaEdit(this)" onblur="handleMetaEdit(this, true)" title="Double click to edit" />
          </td>
        </tr>
      </table>
    </section>

    <!-- 1B. DATA PENDUKUNG UNTUK U1 -->
    <section class="mb-8">
      <h2 class="font-bold mb-3 text-sm flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="bg-green-600 text-white px-2 py-0.5 rounded text-[10px]">üìã</span>
          DATA BATU TIMBANG YANG DIGUNAKAN
        </div>
        <div class="flex gap-2">
          <button onclick="deleteSelectedRows()" title="Hapus Baris Terpilih"
            class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-[10px] flex items-center gap-1 transition-all no-print shadow-sm">
            <span>üóëÔ∏è Hapus Terpilih</span>
          </button>
          <button onclick="addSupportRow()" title="Tambah Baris Baru"
            class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-[10px] flex items-center gap-1 transition-all no-print shadow-sm">
            <span>‚ûï Tambah Baris</span>
          </button>
        </div>
      </h2>
      <p class="text-xs text-gray-600 mb-2 italic">Data Master yang VALID untuk perhitungan U1. Hanya master data dengan
        No. Identitas di bawah ini yang akan digunakan.</p>

      <table class="w-full border border-black border-collapse table-fixed">
        <thead class="bg-gray-200">
          <tr>
            <th class="border border-black px-2 py-2 w-[30px] text-center no-print">
              <input type="checkbox" onchange="toggleAllSupportRows(this)" />
            </th>
            <th class="border border-black px-2 py-2 w-[60px] text-xs">No.</th>
            <th class="border border-black px-2 py-2 text-xs">No. Identitas Batu Timbang</th>
            <th class="border border-black px-2 py-2 text-xs">No. Sertifikat</th>
            <th class="border border-black px-2 py-2 w-[80px] text-xs">Kelas</th>
            <th class="border border-black px-2 py-2 w-[100px] text-xs">Kalibrasi terakhir</th>
            <th class="border border-black px-2 py-2 w-[100px] text-xs">Kalibrasi ulang</th>
          </tr>
        </thead>
        <tbody id="support-table-body">
          <!-- Gererated via JavaScript -->
        </tbody>
      </table>
      </table>

      <script>
        // Helper: Format date ke DD MMM YYYY
        function formatCalibrationDate(dateStr) {
          if (!dateStr) return '';
          const d = new Date(dateStr);
          if (isNaN(d.getTime())) return dateStr;
          const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agt", "Sep", "Okt", "Nov", "Des"];
          return `${d.getDate().toString().padStart(2, '0')} ${months[d.getMonth()]} ${d.getFullYear()}`;
        }

        function toggleAllSupportRows(source) {
          const checkboxes = document.querySelectorAll('.support-row-checkbox');
          checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function deleteSelectedRows() {
          const tbody = document.getElementById('support-table-body');
          const checkboxes = tbody.querySelectorAll('.support-row-checkbox:checked');

          if (checkboxes.length === 0) {
            alert("Pilih baris yang ingin dihapus terlebih dahulu.");
            return;
          }

          if (!confirm(`Yakin ingin menghapus ${checkboxes.length} baris terpilih?`)) return;

          checkboxes.forEach(cb => {
            const row = cb.closest('tr');
            row.remove();
          });

          reindexSupportRows();
          saveSupportData();
        }

        function reindexSupportRows() {
          const tbody = document.getElementById('support-table-body');
          const rows = tbody.querySelectorAll('tr');

          rows.forEach((row, idx) => {
            const newIdx = idx + 1;
            // Update No. Column
            row.cells[1].innerText = newIdx;

            // Update IDs and Event Listeners
            const idInput = row.querySelector('[id^="support-id-"]');
            const certInput = row.querySelector('[id^="support-cert-"]');
            const classInput = row.querySelector('[id^="support-class-"]');
            const lastInput = row.querySelector('[id^="support-last-"]');
            const nextInput = row.querySelector('[id^="support-next-"]');

            if (idInput) {
              idInput.id = `support-id-${newIdx}`;
              idInput.setAttribute('oninput', `handleSupportIdChange(${newIdx})`);
            }
            if (certInput) certInput.id = `support-cert-${newIdx}`;
            if (classInput) classInput.id = `support-class-${newIdx}`;
            if (lastInput) lastInput.id = `support-last-${newIdx}`;
            if (nextInput) nextInput.id = `support-next-${newIdx}`;
          });
        }

        function addSupportRow(data = {}) {
          const tbody = document.getElementById('support-table-body');
          const rowCount = tbody.rows.length;
          const newIdx = rowCount + 1;

          const tr = document.createElement('tr');
          tr.className = "group hover:bg-green-50 transition-colors";
          tr.id = `support-row-${newIdx}`; // Add ID to TR for easier lookup
          tr.innerHTML = `
            <td class="border border-black px-2 py-1 text-center bg-white no-print">
              <input type="checkbox" class="support-row-checkbox" />
            </td>
            <td class="border border-black px-2 py-1 text-center font-bold bg-gray-50">${newIdx}</td>
            <td class="border border-black px-2 py-1">
              <div class="flex items-center gap-1">
                <input type="text" id="support-id-${newIdx}" value="${data.noIdentitas || ''}"
                  class="w-full border-0 focus:outline-none focus:ring-0 p-1 text-xs support-data-input"
                  placeholder="No. Identitas" oninput="handleSupportIdChange(${newIdx})" />
                <button type="button" onclick="openMasterLookup('support-row', 'support-row-${newIdx}')" tabindex="-1"
                  class="p-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition-colors" title="Cari dari Master Data">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                </button>
              </div>
            </td>
            <td class="border border-black px-2 py-1">
              <input type="text" id="support-cert-${newIdx}" value="${data.noSertifikat || ''}"
                class="w-full border-0 focus:outline-none focus:ring-0 p-1 text-xs support-data-input"
                placeholder="No. Sertifikat" oninput="saveSupportData()" />
            </td>
            <td class="border border-black px-2 py-1">
              <input type="text" id="support-class-${newIdx}" value="${data.kelas || ''}"
                class="w-full border-0 focus:outline-none focus:ring-0 p-1 text-xs text-center support-data-input"
                placeholder="F1" oninput="saveSupportData()" />
            </td>
            <td class="border border-black px-2 py-1">
              <input type="text" id="support-last-${newIdx}" value="${data.tglTerakhir || ''}"
                class="w-full border-0 focus:outline-none focus:ring-0 p-1 text-xs text-center bg-gray-50 cursor-not-allowed"
                placeholder="-" readonly />
            </td>
            <td class="border border-black px-2 py-1">
              <input type="text" id="support-next-${newIdx}" value="${data.tglUlang || ''}"
                class="w-full border-0 focus:outline-none focus:ring-0 p-1 text-xs text-center bg-gray-50 cursor-not-allowed"
                placeholder="-" readonly />
            </td>
          `;
          tbody.appendChild(tr);
          if (!data.noIdentitas) saveSupportData();
        }

        function handleSupportIdChange(idx) {
          const masterData = JSON.parse(localStorage.getItem('masterBatuTimbang') || '[]');
          const idInput = document.getElementById(`support-id-${idx}`);
          const idValue = idInput ? idInput.value.trim() : '';
          const lastCell = document.getElementById(`support-last-${idx}`);
          const nextCell = document.getElementById(`support-next-${idx}`);

          if (idValue) {
            const matched = masterData.find(m => m.id === idValue);
            if (matched && matched.tanggal) {
              const lastDate = matched.tanggal;
              const d = new Date(lastDate);
              const nextDate = new Date(d);
              nextDate.setFullYear(d.getFullYear() + 2);

              if (lastCell) lastCell.value = formatCalibrationDate(lastDate);
              if (nextCell) nextCell.value = formatCalibrationDate(nextDate.toISOString().split('T')[0]);
            }
          }
          saveSupportData();
        }

        function loadSupportData() {
          const tbody = document.getElementById('support-table-body');
          if (!tbody) return;
          tbody.innerHTML = '';

          const savedData = JSON.parse(localStorage.getItem('masterDataSupport') || '[]');

          if (savedData.length === 0) {
            // Default 3 rows if no data
            for (let i = 0; i < 3; i++) addSupportRow();
          } else {
            savedData.forEach(data => addSupportRow(data));
          }
          if (typeof calculateUncertainty === 'function') calculateUncertainty();
        }

        function saveSupportData() {
          const tbody = document.getElementById('support-table-body');
          const rows = tbody.querySelectorAll('tr');
          const dataToSave = [];

          rows.forEach((row, idx) => {
            const i = idx + 1;
            const noIdentitas = document.getElementById(`support-id-${i}`)?.value.trim() || '';
            const noSertifikat = document.getElementById(`support-cert-${i}`)?.value.trim() || '';
            const kelas = document.getElementById(`support-class-${i}`)?.value.trim() || '';
            const tglTerakhir = document.getElementById(`support-last-${i}`)?.value.trim() || '';
            const tglUlang = document.getElementById(`support-next-${i}`)?.value.trim() || '';

            if (noIdentitas || noSertifikat || kelas) {
              dataToSave.push({ noIdentitas, noSertifikat, kelas, tglTerakhir, tglUlang });
            }
          });

          localStorage.setItem('masterDataSupport', JSON.stringify(dataToSave));
          if (typeof calculateUncertainty === 'function') calculateUncertainty();
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', loadSupportData);
      </script>
    </section>

    <!-- 2. PENGUJIAN LINEARITAS -->
    <section class="mb-8">
      <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
        <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">2</span>
        PENGUJIAN Pre-Adjustment
      </h2>
      <table class="w-full border border-black border-collapse table-fixed text-center">
        <thead>
          <tr class="bg-gray-200 font-bold">
            <th class="border border-black w-[130px] py-3" rowspan="2">Position</th>
            <th class="border border-black w-[110px] py-3" rowspan="2">Nominal Batu Timbang <br> <span
                class="unit-label">(g)</span></th>
            <th class="border border-black w-[150px] py-3" rowspan="2">Massa Konvensional (Mc) <br><span
                class="unit-label">g</span>)</th>
            <th class="border border-black py-1" colspan="2">Pembacaan <br><span class="unit-label">(g)</span></th>
            <th class="border border-black py-1" colspan="2">Rata-rata (Z & R) <br><span class="unit-label">(g)</span>
            </th>
            <th class="border border-black w-[140px] py-3" rowspan="2">Perbedaan Pembacaan (Ri = Rata2 (R) - Rata-rata
              (Z)) <br><span class="unit-label">(g)</span></th>
            <th class="border border-black w-[120px] py-3" rowspan="2">Koreksi (C = Mc -Ri) <br><span
                class="unit-label">(g)</span></th>
            <th class="border border-black w-[120px] py-3" rowspan="2">Koreksi Absolut</th>
          </tr>
        </thead>
        <tbody>
          <!-- PRE-ADJUSTMENT -->
          <tr>
            <td class="border border-black font-bold p-2" rowspan="4">Pre-Adjustment</td>
            <td class="border border-black relative group p-2" rowspan="4">
              <span id="pre-adj-nominal" data-base-weight="2000" class="no-decimal">2000</span>
              <div class="absolute top-1 right-1 flex gap-1 no-print">
                <button onclick="openMasterLookup('pre-adj')" title="Cari dari Master"
                  class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                  </svg>
                </button>
              </div>
            </td>
            <td id="pre-adj-mc" class="border border-black p-2 mc-cell" rowspan="4" data-base-weight="2000.0023">
              2000,002300
            </td>
            <td class="border border-black bg-gray-50 py-1">Z‚ÇÅ</td>
            <td class="border border-black p-0"><input type="text"
                class="w-full border-0 text-center focus:outline-none focus:ring-0 p-1 pre-adj-z1" placeholder="0,0"
                oninput="calculatePreAdjustment()" /></td>
            <td class="border border-black bg-gray-50 py-1" rowspan="2">Z</td>
            <td class="border border-black p-0" rowspan="2"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 pre-adj-z-avg"
                placeholder="0" readonly /></td>
            <td class="border border-black p-0" rowspan="4"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 pre-adj-ri"
                placeholder="1000,0" readonly /></td>
            <td class="border border-black p-0" rowspan="4"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 pre-adj-correction"
                placeholder="-0,0020" readonly /></td>
            <td class="border border-black p-0" rowspan="4"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 pre-adj-abs-correction"
                placeholder="0,002" readonly /></td>
          </tr>
          <tr>
            <td class="border border-black bg-gray-50 py-1">R‚ÇÅ</td>
            <td class="border border-black p-0"><input type="text"
                class="w-full border-0 text-center focus:outline-none focus:ring-0 p-1 pre-adj-r1" placeholder="1000,0"
                oninput="calculatePreAdjustment()" /></td>
          </tr>
          <tr>
            <td class="border border-black bg-gray-50 py-1">R‚ÇÇ</td>
            <td class="border border-black p-0"><input type="text"
                class="w-full border-0 text-center focus:outline-none focus:ring-0 p-1 pre-adj-r2" placeholder="1000,0"
                oninput="calculatePreAdjustment()" /></td>
            <td class="border border-black bg-gray-50 py-1" rowspan="2">R</td>
            <td class="border border-black p-0" rowspan="2"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 pre-adj-r-avg"
                placeholder="1000,0" readonly /></td>
          </tr>
          <tr>
            <td class="border border-black bg-gray-50 py-1">Z‚ÇÇ</td>
            <td class="border border-black p-0"><input type="text"
                class="w-full border-0 text-center focus:outline-none focus:ring-0 p-1 pre-adj-z2" placeholder="0,0"
                oninput="calculatePreAdjustment()" /></td>
          </tr>

          <!-- POST-ADJUSTMENT -->
          <tr class="border-t-2 border-black">
            <td class="border border-black font-bold p-2" rowspan="4">Post-Adjustment</td>
            <td class="border border-black relative group p-2" rowspan="4">
              <span id="post-adj-nominal" data-base-weight="2000" class="no-decimal">2000</span>
              <div class="absolute top-1 right-1 flex gap-1 no-print">
                <button onclick="openMasterLookup('post-adj')" title="Cari dari Master"
                  class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.35-4.35" />
                  </svg>
                </button>
              </div>
            </td>
            <td id="post-adj-mc" class="border border-black p-2 mc-cell" rowspan="4" data-base-weight="2000.0023">
              2000,002300</td>
            <td class="border border-black bg-gray-50 py-1">Z‚ÇÅ</td>
            <td class="border border-black p-0"><input type="text"
                class="w-full border-0 text-center focus:outline-none focus:ring-0 p-1 post-adj-z1" placeholder="0,0"
                oninput="calculatePostAdjustment()" /></td>
            <td class="border border-black bg-gray-50 py-1" rowspan="2">Z</td>
            <td class="border border-black p-0" rowspan="2"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 post-adj-z-avg"
                placeholder=" " readonly /></td>
            <td class="border border-black p-0" rowspan="4"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 post-adj-ri"
                placeholder="1000,0" readonly /></td>
            <td class="border border-black p-0" rowspan="4"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 post-adj-correction"
                placeholder="" readonly /></td>
            <td class="border border-black p-0" rowspan="4"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 post-adj-abs-correction"
                placeholder="0,002" readonly /></td>
          </tr>
          <tr>
            <td class="border border-black bg-gray-50 py-1">R‚ÇÅ</td>
            <td class="border border-black p-0"><input type="text"
                class="w-full border-0 text-center focus:outline-none focus:ring-0 p-1 post-adj-r1" placeholder="1000,0"
                oninput="calculatePostAdjustment()" /></td>
          </tr>
          <tr>
            <td class="border border-black bg-gray-50 py-1">R‚ÇÇ</td>
            <td class="border border-black p-0"><input type="text"
                class="w-full border-0 text-center focus:outline-none focus:ring-0 p-1 post-adj-r2" placeholder="1000,0"
                oninput="calculatePostAdjustment()" /></td>
            <td class="border border-black bg-gray-50 py-1" rowspan="2">R</td>
            <td class="border border-black p-0" rowspan="2"><input type="text"
                class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-1 post-adj-r-avg"
                placeholder="1000,0" readonly /></td>
          </tr>
          <tr>
            <td class="border border-black bg-gray-50 py-1">Z‚ÇÇ</td>
            <td class="border border-black p-0"><input type="text"
                class="w-full border-0 text-center focus:outline-none focus:ring-0 p-1 post-adj-z2" placeholder="0,0"
                oninput="calculatePostAdjustment()" /></td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- 3. PENGUJIAN REPEATABILITY -->
    <section class="mb-8">
      <script>
        // Inisialisasi variabel global untuk desimal
        let g_decimals = 1; // Default
        let g_stdMax = 0;   // High precision for Uncertainty calculations
        let g_linearityX = 0; // High precision for LOP
        let g_u95Max = 0;    // High precision for LOP

        // Unit Conversion State
        let g_currentUnit = "g"; // Default unit

        function convertToUnit(value, unit = g_currentUnit) {
          if (unit === "kg") return value / 1000;
          if (unit === "mg") return value * 1000;
          return value; // g is base
        }

        function convertFromUnit(value, unit = g_currentUnit) {
          if (unit === "kg") return value * 1000;
          if (unit === "mg") return value / 1000;
          return value; // g is base
        }

        function updateUnitLabels() {
          const labels = document.querySelectorAll(".unit-label");
          labels.forEach(el => {
            el.innerText = `(${g_currentUnit})`;
          });
          updateSpecsDisplay();
        }

        function updateSpecsDisplay() {
          const el = document.getElementById('specs-cell');
          const inputCap = document.getElementById('input-cap');
          const inputD = document.getElementById('input-d');
          const inputE = document.getElementById('input-e');

          if (!el || !el.dataset.cap) return;

          const cap = parseFloat(el.dataset.cap);
          const dLabel = parseFloat(el.dataset.d);
          const eLabel = parseFloat(el.dataset.e);

          if (isNaN(cap) || isNaN(dLabel) || isNaN(eLabel)) return;

          // Natural formatting for Cap and E (only show decimals if they exist)
          const formatFlexible = (val) => {
            const conv = convertToUnit(val);
            // Use up to 9 decimals but remove trailing zeros and decimal point if unnecessary
            const s = Number(conv.toFixed(9)).toString();
            return s.replace('.', ',');
          };

          const capDisplay = formatFlexible(cap);
          const dDisplay = formatNumber(dLabel); // Keep d tied to resolution
          const eDisplay = formatFlexible(eLabel);

          // Update hidden span for text-based fallback
          el.innerText = `${capDisplay} ${g_currentUnit} / ${dDisplay} ${g_currentUnit} / ${eDisplay} ${g_currentUnit}`;

          // Update inputs if they are not being edited
          if (inputCap && document.activeElement !== inputCap) inputCap.value = capDisplay;
          if (inputD && document.activeElement !== inputD) inputD.value = dDisplay;
          if (inputE && document.activeElement !== inputE) inputE.value = eDisplay;
        }

        function saveSpecs() {
          const inputCap = document.getElementById('input-cap');
          const inputD = document.getElementById('input-d');
          const inputE = document.getElementById('input-e');
          const specsCell = document.getElementById('specs-cell');

          if (!inputCap || !inputD || !inputE || !specsCell) return;

          // Parse from current unit back to grams
          const capG = convertFromUnit(parseNumber(inputCap.value));
          const dG = convertFromUnit(parseNumber(inputD.value));
          const eG = convertFromUnit(parseNumber(inputE.value));

          // Only update if they are valid numbers
          if (!isNaN(capG) && capG > 0) specsCell.dataset.cap = capG;
          if (!isNaN(dG) && dG > 0) specsCell.dataset.d = dG;
          if (!isNaN(eG) && eG > 0) specsCell.dataset.e = eG;

          // Store in localStorage
          localStorage.setItem('calibrationSpecs', JSON.stringify({
            cap: specsCell.dataset.cap,
            d: specsCell.dataset.d,
            e: specsCell.dataset.e
          }));

          // Trigger dynamic updates
          updateGlobalPrecision();
          updateSpecsDisplay();
          if (typeof calculateRepeatability === 'function') calculateRepeatability();
          if (typeof calculateUncertainty === 'function') calculateUncertainty();
        }

        function loadSpecs() {
          const saved = localStorage.getItem('calibrationSpecs');
          const specsCell = document.getElementById('specs-cell');
          if (!specsCell) return;

          if (saved) {
            try {
              const data = JSON.parse(saved);
              if (data.cap) specsCell.dataset.cap = data.cap;
              if (data.d) specsCell.dataset.d = data.d;
              if (data.e) specsCell.dataset.e = data.e;
            } catch (e) {
              console.error("Error loading specs:", e);
            }
          }

          updateSpecsDisplay();
          updateGlobalPrecision();
        }

        function refreshStaticWeights() {
          const elements = document.querySelectorAll("[data-base-weight]");
          elements.forEach(el => {
            const isMC = el.id.toLowerCase().includes('mc') || el.classList.contains('mc-cell');
            const grams = parseFloat(el.dataset.baseWeight);
            if (!isNaN(grams)) {
              let dec = null;
              if (isMC) {
                // Tiered precision for MC (Kg: 9, g: 7, mg: 5)
                dec = 9;
                if (g_currentUnit === 'g') dec = 7;
                else if (g_currentUnit === 'mg') dec = 5;
              } else if (el.classList.contains('no-decimal')) {
                // Nominal: 0 decimals if whole number, otherwise show full precision (up to 9 decimals)
                const converted = convertToUnit(grams);
                const s = converted.toString();
                if (s.includes('.') || s.includes('e-')) {
                  const cleaned = Number(converted.toFixed(10)).toString();
                  if (cleaned.includes('.')) {
                    dec = cleaned.split('.')[1].length;
                  } else if (cleaned.includes('e-')) {
                    dec = parseInt(cleaned.split('e-')[1]);
                  } else {
                    dec = 0;
                  }
                  if (dec > 9) dec = 9;
                } else {
                  dec = 0;
                }
              }

              const formatted = formatNumber(grams, dec);

              if (el.tagName === 'INPUT') {
                el.value = formatted;
              } else {
                el.innerText = formatted;
              }
            }
          });
        }

        function handleUnitChange(newUnit) {
          g_currentUnit = newUnit;
          updateUnitLabels();
          refreshStaticWeights();
          refreshAllTableFormatting();
        }
        // Fungsi untuk mengambil resolusi dari teks spesifikasi "1200 g / 0.1g / 1 g"
        // SELALU mengembalikan nilai dalam GRAM
        function getResolutionFromSpecs() {
          const specsCell = document.getElementById("specs-cell");
          if (specsCell && specsCell.dataset.d) {
            return parseFloat(specsCell.dataset.d);
          }

          const specsInput = document.getElementById("specs-cell-input");
          let text = "";

          if (specsInput) text = specsInput.value;
          else if (specsCell) text = specsCell.innerText;
          else return 0.1;

          const parts = text.split("/");
          if (parts.length >= 2) {
            const dayaBacaStr = parts[1].trim().toLowerCase().replace("g", "").trim().replace(",", ".");
            const val = parseFloat(dayaBacaStr);
            return (!isNaN(val) && val > 0) ? val : 0.1;
          }
          return 0.1;
        }

        // Update desimal global berdasarkan resolusi (dalam unit saat ini)
        function updateGlobalPrecision() {
          const resGrams = getResolutionFromSpecs();
          const resCurrentUnit = convertToUnit(resGrams);
          let decimals = 0;
          if (resCurrentUnit > 0) {
            decimals = Math.max(0, -Math.floor(Math.log10(resCurrentUnit) + 0.0000000001));
          }
          g_decimals = decimals;
          return g_decimals;
        }

        function getAccuracyClass() {
          const savedClass = localStorage.getItem('calibrationClass');
          if (savedClass) return savedClass;
          // Fallback to calibrationSettings if available
          const settings = JSON.parse(localStorage.getItem('calibrationSettings') || '{}');
          if (settings.accuracyClass) return settings.accuracyClass;
          return "II"; // Default
        }

        function getVerificationScaleInterval() {
          const savedE = localStorage.getItem('calibrationE');
          if (savedE && !isNaN(parseFloat(savedE))) return parseFloat(savedE);

          // Fallback to specs-cell
          const specsCell = document.getElementById("specs-cell");
          if (specsCell && specsCell.dataset.e) return parseFloat(specsCell.dataset.e);

          const innerText = specsCell ? specsCell.innerText : "";
          if (innerText.includes("/")) {
            const eVal_str = innerText.split("/").pop().replace("g", "").trim().replace(",", ".");
            const val = parseFloat(eVal_str);
            if (!isNaN(val)) return val;
          }

          // Last fallback: use d * 10 or 1
          const d = getResolutionFromSpecs();
          return d * 10 || 1;
        }

        function getMPEFactor(m, accClass) {
          // Based on Table 4 (MPE Initial Verification) - OIML R76-1
          const cleanClass = String(accClass || "II").toUpperCase();
          const absM = Math.abs(m);

          // Class I check (Requires strict Match to avoid overlap with II, III, IIII)
          if (cleanClass === "I" || (cleanClass.includes("(I)") && !cleanClass.includes("II"))) {
            if (absM >= 0 && absM <= 50000) return 0.5;
            if (absM > 50000 && absM <= 200000) return 1.0;
            if (absM > 200000) return 1.5;
          }
          // Class II check
          else if (cleanClass === "II" || cleanClass.includes("(II)")) {
            if (absM >= 0 && absM <= 5000) return 0.5;
            if (absM > 5000 && absM <= 20000) return 1.0;
            if (absM > 20000 && absM <= 100000) return 1.5;
          }
          // Class III check
          else if (cleanClass === "III" || cleanClass.includes("(III)")) {
            if (absM >= 0 && absM <= 500) return 0.5;
            if (absM > 500 && absM <= 2000) return 1.0;
            if (absM > 2000 && absM <= 10000) return 1.5;
          }
          // Class IIII check
          else if (cleanClass === "IIII" || cleanClass === "IV" || cleanClass.includes("(IIII)") || cleanClass.includes("(IV)")) {
            if (absM >= 0 && absM <= 50) return 0.5;
            if (absM > 50 && absM <= 200) return 1.0;
            if (absM > 200 && absM <= 1000) return 1.5;
          }
          return 1.0; // Fail-safe fallback factor
        }

        function getCapacityFromSpecs() {
          const specsCell = document.getElementById("specs-cell");
          if (specsCell && specsCell.dataset.cap) {
            return parseFloat(specsCell.dataset.cap);
          }

          const specsInput = document.getElementById("specs-cell-input");
          let text = "";

          if (specsInput) text = specsInput.value;
          else if (specsCell) text = specsCell.innerText;
          else return 1200;

          const parts = text.split("/");
          if (parts.length >= 1) {
            const capStr = parts[0].trim().toLowerCase().replace("g", "").trim().replace(",", ".");
            const val = parseFloat(capStr);
            return (!isNaN(val) && val > 0) ? val : 3100;
          }
          return 3100;
        }

        function toleransiKalibrasi() {
          const d = getResolutionFromSpecs();
          const max = getCapacityFromSpecs();
          localStorage.setItem('calibrationReadability', d);
          localStorage.setItem('calibrationCapacity', max);
          window.location.href = "toleransiKalibrasi.html";
        }

        // Fungsi untuk mengonversi string dengan koma desimal ke float
        function parseNumber(value) {
          if (!value) return 0;
          if (typeof value === 'number') return convertFromUnit(value);
          // Ganti koma dengan titik untuk parsing
          const cleanValue = String(value).replace(/\./g, "").replace(",", ".");
          const parsed = parseFloat(cleanValue) || 0;
          return convertFromUnit(parsed);
        }

        // Fungsi untuk memformat angka dengan koma desimal dan presisi yang sesuai
        function formatNumber(num, decimals = null) {
          if (num === null || num === undefined || isNaN(num)) return "-";

          // Always convert from gram (base) to current unit
          const convertedNum = convertToUnit(num);

          // Robustly determine decimals
          let d = (decimals === null) ? g_decimals : decimals;
          if (isNaN(d) || d < 0) d = 0;
          if (d > 20) d = 20; // toFixed limitation

          if (convertedNum === 0) {
            if (d === 0) return "0";
            return "0," + "0".repeat(d);
          }

          // Robust rounding to handle floating point noise (e.g., 1.105 -> 1.11)
          const multiplier = Math.pow(10, d);
          const roundedNum = Math.round(convertedNum * multiplier + 0.0000000001) / multiplier;
          return roundedNum.toFixed(d).replace(".", ",");
        }

        // Fungsi khusus untuk format angka di Tabel Regresi (dengan titik ribuan)
        function formatRegressionNumber(num, decimals = null) {
          if (num === null || num === undefined || isNaN(num)) return "-";

          const convertedNum = convertToUnit(num);
          const d = (decimals === null) ? g_decimals : decimals;

          return new Intl.NumberFormat('id-ID', {
            minimumFractionDigits: d,
            maximumFractionDigits: d
          }).format(convertedNum);
        }

        // Helper for all-purpose calculation logic
        function calculateAverage(arr) {
          if (!arr || arr.length === 0) return 0;
          const sum = arr.reduce((a, b) => a + b, 0);
          return sum / arr.length;
        }

        function calculateSampleStandardDeviation(arr) {
          if (!arr || arr.length < 2) return 0;
          const avg = calculateAverage(arr);
          const sumSquaredDiff = arr.reduce((sum, value) => sum + Math.pow(value - avg, 2), 0);
          return Math.sqrt(sumSquaredDiff / (arr.length - 1));
        }

        function calculatePopulationStandardDeviation(arr) {
          if (!arr || arr.length < 2) return 0;
          const avg = calculateAverage(arr);
          const sumSquaredDiff = arr.reduce((sum, value) => sum + Math.pow(value - avg, 2), 0);
          return Math.sqrt(sumSquaredDiff / arr.length);
        }

        function calculateRSD(sd, mean) {
          if (mean === 0) return 0;
          return (sd / mean) * 100;
        }

        // Fungsi untuk menghitung Pre-Adjustment
        function calculatePreAdjustment() {
          // Pastikan desimal terupdate
          updateGlobalPrecision();

          // Ambil nilai input
          const z1Input = document.querySelector(".pre-adj-z1");
          const z2Input = document.querySelector(".pre-adj-z2");
          const r1Input = document.querySelector(".pre-adj-r1");
          const r2Input = document.querySelector(".pre-adj-r2");

          const z1 = parseNumber(z1Input.value);
          const z2 = parseNumber(z2Input.value);
          const r1 = parseNumber(r1Input.value);
          const r2 = parseNumber(r2Input.value);
          // Ambil Mc dari tabel (dinamis)
          const mcCell = document.getElementById('pre-adj-mc');
          const mcG = mcCell ? parseFloat(mcCell.dataset.baseWeight || 0) : 0;
          const mc = convertToUnit(mcG);

          // Hitung rata-rata (simpan nilai presisi penuh untuk perhitungan)
          const zAvg = (z1 + z2) / 2;
          const rAvg = (r1 + r2) / 2;

          // Hitung Perbedaan Pembacaan (Ri) - gunakan nilai presisi penuh
          const ri = rAvg - zAvg;

          // Hitung Koreksi
          const correction = mc - ri;

          // Hitung Koreksi Absolut
          const absCorrection = Math.abs(correction);

          // Update nilai di form dengan format GLOBAL
          // Pembacaan (Z & R) - Hanya format jika tidak sedang aktif (focus)
          if (z1Input.value !== "" && document.activeElement !== z1Input) z1Input.value = formatNumber(z1);
          if (z2Input.value !== "" && document.activeElement !== z2Input) z2Input.value = formatNumber(z2);
          if (r1Input.value !== "" && document.activeElement !== r1Input) r1Input.value = formatNumber(r1);
          if (r2Input.value !== "" && document.activeElement !== r2Input) r2Input.value = formatNumber(r2);

          // Z rata-rata - bulatkan sesuai Daya Baca
          const zAvgRounded = Math.round(zAvg * Math.pow(10, g_decimals)) / Math.pow(10, g_decimals);
          document.querySelector(".pre-adj-z-avg").value = formatNumber(zAvgRounded, g_decimals);

          // R rata-rata - bulatkan sesuai Daya Baca
          const rAvgRounded = Math.round(rAvg * Math.pow(10, g_decimals)) / Math.pow(10, g_decimals);
          document.querySelector(".pre-adj-r-avg").value = formatNumber(rAvgRounded, g_decimals);

          // Ri - untuk tampilan, hitung dari nilai yang sudah dibulatkan
          const riDisplay = rAvgRounded - zAvgRounded;
          document.querySelector(".pre-adj-ri").value = formatNumber(riDisplay, g_decimals);

          // Koreksi - tetap 4 desimal untuk konsistensi (sesuai standar)
          document.querySelector(".pre-adj-correction").value = formatNumber(correction, 4);

          // Koreksi Absolut - 4 desimal (sama dengan Koreksi)
          document.querySelector(".pre-adj-abs-correction").value = formatNumber(absCorrection, 4);
        }

        // Fungsi untuk menghitung Post-Adjustment
        function calculatePostAdjustment() {
          // Ambil nilai input
          const z1Input = document.querySelector(".post-adj-z1");
          const z2Input = document.querySelector(".post-adj-z2");
          const r1Input = document.querySelector(".post-adj-r1");
          const r2Input = document.querySelector(".post-adj-r2");

          const z1Value = z1Input.value;
          const z2Value = z2Input.value;
          const r1Value = r1Input.value;
          const r2Value = r2Input.value;

          const z1 = parseNumber(z1Value);
          const z2 = parseNumber(z2Value);
          const r1 = parseNumber(r1Value);
          const r2 = parseNumber(r2Value);
          // Ambil Mc dari tabel (dinamis)
          const mcCell = document.getElementById('post-adj-mc');
          const mcG = mcCell ? parseFloat(mcCell.dataset.baseWeight || 0) : 0;
          const mc = convertToUnit(mcG);

          // Hitung rata-rata (simpan nilai presisi penuh untuk perhitungan)
          const zAvg = (z1 + z2) / 2;
          const rAvg = (r1 + r2) / 2;

          // Hitung Perbedaan Pembacaan (Ri) - gunakan nilai presisi penuh
          const ri = rAvg - zAvg;

          // Hitung Koreksi
          const correction = mc - ri;

          // Hitung Koreksi Absolut
          const absCorrection = Math.abs(correction);

          // Update nilai di form dengan format GLOBAL
          // Z rata-rata - bulatkan sesuai Daya Baca
          const zAvgRounded = Math.round(zAvg * Math.pow(10, g_decimals)) / Math.pow(10, g_decimals);
          document.querySelector(".post-adj-z-avg").value = formatNumber(zAvgRounded, g_decimals);

          // R rata-rata - bulatkan sesuai Daya Baca
          const rAvgRounded = Math.round(rAvg * Math.pow(10, g_decimals)) / Math.pow(10, g_decimals);
          document.querySelector(".post-adj-r-avg").value = formatNumber(rAvgRounded, g_decimals);

          // Ri - untuk tampilan, hitung dari nilai yang sudah dibulatkan
          const riDisplay = rAvgRounded - zAvgRounded;
          document.querySelector(".post-adj-ri").value = formatNumber(riDisplay, g_decimals);

          // Koreksi - tetap 4 desimal
          document.querySelector(".post-adj-correction").value = formatNumber(correction, 4);

          // Koreksi Absolut - 4 desimal (sama dengan Koreksi)
          document.querySelector(".post-adj-abs-correction").value = formatNumber(absCorrection, 4);
        }

        // Fungsi untuk menyegarkan semua pemformatan tabel
        function refreshAllTableFormatting() {
          // Update presisi global
          updateGlobalPrecision();

          // Update Nominal and MC values which use data-base-weight
          refreshStaticWeights();

          // Trigger perhitungan ulang untuk Tabel 1 & 2
          calculatePreAdjustment();
          calculatePostAdjustment();

          // Trigger perhitungan ulang untuk Tabel 3 (Repeatability)
          if (typeof calculateRepeatability === 'function') {
            calculateRepeatability();
          }

          // Trigger perhitungan ulang untuk Tabel 4 (Linearity) - via event dispatch
          const linTable = document.getElementById('linearity-table');
          if (linTable) {
            const firstInput = linTable.querySelector('input:not([readonly])');
            if (firstInput) {
              firstInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
          }
        }

        // Inisialisasi perhitungan saat halaman dimuat
        document.addEventListener("DOMContentLoaded", function () {
          refreshAllTableFormatting();

          // Observer untuk mendeteksi perubahan pada specs-cell (Daya Baca)
          const specsCell = document.getElementById("specs-cell");
          if (specsCell) {
            const observer = new MutationObserver(() => {
              refreshAllTableFormatting();
            });
            observer.observe(specsCell, { characterData: true, childList: true, subtree: true });
          }

          // Global focusout listener to format inputs when editing finishes
          document.addEventListener("focusout", function (e) {
            const excludedIds = ['cert-no', 'no-identitas', 'env-suhu', 'env-rh', 'env-pa', 'form-no', 'rev-no', 'eff-date', 'input-cap', 'input-e'];
            if (
              e.target.tagName === 'INPUT' &&
              !e.target.hasAttribute('readonly') &&
              !excludedIds.includes(e.target.id) &&
              !e.target.classList.contains('support-data-input') && // Tambahkan pengecualian di sini
              e.target.type !== 'date'
            ) {
              // Re-run the specific table calculation to trigger formatting
              const rawVal = e.target.value.trim();
              const val = parseNumber(rawVal);
              if (rawVal !== "" && rawVal !== "-" && !isNaN(val)) {
                // Check if the input should have no decimals
                const dec = e.target.classList.contains('no-decimal') ? 0 : null;
                e.target.value = formatNumber(val, dec);
              }
            }
          });
        });

        // Handle double-click to edit metadata (Global Scope)
        function handleMetaEdit(el, isBlur = false) {
          if (!isBlur) {
            // Double click: Unlock
            el.removeAttribute('readonly');
            el.classList.remove('cursor-not-allowed', 'bg-gray-100', 'text-gray-700');
            el.classList.add('bg-white', 'text-black');
            el.focus();
          } else {
            // Blur: Lock
            el.setAttribute('readonly', true);
            el.classList.add('cursor-not-allowed', 'bg-gray-100', 'text-gray-700');
            el.classList.remove('bg-white', 'text-black');
          }
        }
      </script>

      <!-- 3. PENGUJIAN REPEATABILITAS -->
      <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
        <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">3</span>
        PENGUJIAN REPEATABILITAS
      </h2>

      <div class="w-full overflow-x-auto mb-4">
        <table class="w-full border border-black border-collapse mb-4">
          <thead>
            <tr class="bg-gray-200 text-center font-bold">
              <th class="border border-black w-[50px]" rowspan="3">No.</th>
              <th class="border border-black" colspan="3">
                Nominal 50% :
                <input type="text" id="nominal-50" data-base-weight="600"
                  class="w-20 bg-gray-200 border-0 text-center font-normal focus:outline-none focus:ring-0 p-0 no-decimal"
                  placeholder="600" value="600"
                  oninput="this.dataset.baseWeight = convertFromUnit(parseNumber(this.value)); updateRiPlaceholders();" />
                <span class="unit-label">g</span>
              </th>
              <th class="border border-black" colspan="3">
                Nominal 100% :
                <input type="text" id="nominal-100" data-base-weight="1200"
                  class="w-20 bg-gray-200 border-0 text-center font-normal focus:outline-none focus:ring-0 p-0 no-decimal"
                  placeholder="1200" value="1200"
                  oninput="this.dataset.baseWeight = convertFromUnit(parseNumber(this.value)); updateRiPlaceholders();" />
                <span class="unit-label">g</span>
              </th>
            </tr>
            <tr class="bg-gray-200 text-center font-bold">
              <th class="border border-black">
                Zero (Zi)
              </th>
              <th class="border border-black">
                Pembacaan (Ri)
              </th>
              <th class="border border-black">
                Perbedaan Pembacaan (Ri - Zi)
              </th>
              <th class="border border-black">
                Zero (Zi)
              </th>
              <th class="border border-black">
                Pembacaan (Ri)
              </th>
              <th class="border border-black">
                Perbedaan Pembacaan (Ri - Zi)
              </th>
            </tr>
          </thead>
          <tbody class="text-center">
            <!-- Baris 1-10 -->
            <!-- Baris 1 -->
            <tr>
              <td class="border border-black">1</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-1"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-1"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-1"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-1"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-1"
                  placeholder="1200,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-1"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 2 -->
            <tr>
              <td class="border border-black">2</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-2"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-2"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-2"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-2"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-2"
                  placeholder="1200,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-2"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 3 -->
            <tr>
              <td class="border border-black">3</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-3"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-3"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-3"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-3"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-3"
                  placeholder="1200,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-3"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 4 -->
            <tr>
              <td class="border border-black">4</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-4"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-4"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-4"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-4"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-4"
                  placeholder="1200,1" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-4"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 5 -->
            <tr>
              <td class="border border-black">5</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-5"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-5"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-5"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-5"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-5"
                  placeholder="1200,1" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-5"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 6 -->
            <tr>
              <td class="border border-black">6</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-6"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-6"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-6"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-6"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-6"
                  placeholder="1200,1" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-6"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 7 -->
            <tr>
              <td class="border border-black">7</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-7"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-7"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-7"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-7"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-7"
                  placeholder="1200,1" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-7"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 8 -->
            <tr>
              <td class="border border-black">8</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-8"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-8"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-8"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-8"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-8"
                  placeholder="1200,1" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-8"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 9 -->
            <tr>
              <td class="border border-black">9</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-9"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-9"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-9"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-9"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-9"
                  placeholder="1200,1" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-9"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- Baris 10 -->
            <tr>
              <td class="border border-black">10</td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z50-10"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r50-10"
                  placeholder="600,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff50-10"
                  placeholder="-" readonly />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-z100-10"
                  placeholder="0,0" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 repeat-r100-10"
                  placeholder="1200,1" oninput="calculateRepeatability()" />
              </td>
              <td class="border border-black">
                <input type="text"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 repeat-diff100-10"
                  placeholder="-" readonly />
              </td>
            </tr>

            <!-- BARIS RATA-RATA -->
            <tr>
              <td class="border border-black bg-gray-200 text-center pl-4 font-bold" colspan="3">
                Rata - rata
              </td>
              <td class="border border-black text-center">
                <input type="text" id="avg-50"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0" placeholder="-"
                  readonly />
              </td>
              <td class="border border-black bg-gray-200 text-center pl-4 font-bold" colspan="2">
                Rata - rata
              </td>
              <td class="border border-black text-center">
                <input type="text" id="avg-100"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0" placeholder="-"
                  readonly />
              </td>
            </tr>

            <tr>
              <td class="border border-black bg-gray-200 text-center pl-4 font-bold" colspan="3">
                SD
              </td>
              <td class="border border-black text-center">
                <input type="text" id="sd-50"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0" placeholder="-"
                  readonly />
              </td>
              <td class="border border-black bg-gray-200 text-center pl-4 font-bold" colspan="2">
                SD
              </td>
              <td class="border border-black text-center">
                <input type="text" id="sd-100"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0" placeholder="-"
                  readonly />
              </td>
            </tr>
          </tbody>
          <tbody>
            <!-- BARIS STANDAR DEVIASI TEORITIS -->
            <tr>
              <td colspan="4"></td>
              <td class="border border-black bg-gray-200 text-center font-bold" colspan="2">
                Standar Deviasi Teoritis
              </td>
              <td class="border border-black text-center">
                <input type="text" id="std-theoretical"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                  placeholder="0,041" readonly />
              </td>
            </tr>

            <!-- BARIS STANDAR DEVIASI MAKSIMUM -->
            <tr>
              <td class="border border-black bg-gray-200 text-center font-bold" colspan="4">
                Jika Smaks < 0,41*d; gunakan Standar Deviasi Teoritis </td>
              <td class="border border-black bg-gray-200 text-center font-bold" colspan="2">
                Standar Deviasi Maksimum
              </td>
              <td class="border border-black text-center">
                <input type="text" id="std-max"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0" placeholder="-"
                  readonly />
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <script>
        // Fungsi utama untuk menghitung repeatability
        function calculateRepeatability() {
          // Ensure decimals are updated
          updateGlobalPrecision();

          const diff50 = [];
          const diff100 = [];

          // Ambil nilai daya baca (d) - dinamis dari spesifikasi timbangan
          const d = getResolutionFromSpecs();

          // Hitung perbedaan untuk setiap baris (1-10)
          for (let i = 1; i <= 10; i++) {
            // Untuk 50%
            const z50 = parseNumber(
              document.querySelector(`.repeat-z50-${i}`).value
            );
            const r50 = parseNumber(
              document.querySelector(`.repeat-r50-${i}`).value
            );
            const diff50Value = r50 - z50;

            // Untuk 100%
            const z100 = parseNumber(
              document.querySelector(`.repeat-z100-${i}`).value
            );
            const r100 = parseNumber(
              document.querySelector(`.repeat-r100-${i}`).value
            );
            const diff100Value = r100 - z100;

            // Simpan ke array
            diff50.push(diff50Value);
            diff100.push(diff100Value);

            // Update input Ri if not empty (follows Daya Baca) - Only format if not focused
            const riInput50 = document.querySelector(`.repeat-r50-${i}`);
            const riInput100 = document.querySelector(`.repeat-r100-${i}`);
            if (riInput50.value !== "" && document.activeElement !== riInput50) riInput50.value = formatNumber(r50);
            if (riInput100.value !== "" && document.activeElement !== riInput100) riInput100.value = formatNumber(r100);

            // Update perbedaan pembacaan untuk setiap baris
            document.querySelector(`.repeat-diff50-${i}`).value = formatNumber(
              diff50Value
            );
            document.querySelector(`.repeat-diff100-${i}`).value = formatNumber(
              diff100Value
            );
          }

          // Hitung rata-rata
          const avg50 = calculateAverage(diff50);
          const avg100 = calculateAverage(diff100);

          // Hitung standar deviasi SAMPEL (seperti Excel STDEV)
          const sd50 = calculateSampleStandardDeviation(diff50);
          const sd100 = calculateSampleStandardDeviation(diff100);

          // Hitung %RSD
          const rsd50 = calculateRSD(sd50, avg50);
          const rsd100 = calculateRSD(sd100, avg100);

          // Hitung standar deviasi teoritis (0,41*d)
          const stdTheoretical = 0.41 * d;

          // Untuk standar deviasi maksimum, gunakan logika:
          // Jika Smaks < 0,41*d; gunakan Standar Deviasi Teoritis
          // Jika tidak, gunakan SD yang dihitung
          const stdMax = sd100 < stdTheoretical ? stdTheoretical : sd100;

          // Simpan ke variabel global untuk presisi perhitungan Uncertainty
          g_stdMax = stdMax;

          // Update nilai di tabel
          const sdPrec = 4; // Fixed to 4 decimals as requested
          document.getElementById("avg-50").value = formatNumber(avg50, 4);
          document.getElementById("avg-100").value = formatNumber(avg100, 4);
          document.getElementById("sd-50").value = formatNumber(sd50, sdPrec);
          document.getElementById("sd-100").value = formatNumber(sd100, sdPrec);
          document.getElementById("std-theoretical").value = formatNumber(
            stdTheoretical,
            sdPrec
          );
          document.getElementById("std-max").value = formatNumber(stdMax, sdPrec);

          // Trigger other calculations
          if (typeof calculateUncertainty === 'function') calculateUncertainty();
          if (typeof calculateLOP === 'function') calculateLOP();
        }

        // Fungsi untuk mengupdate placeholder pembacaan Ri berdasarkan nominal
        function updateRiPlaceholders() {
          const nominal50 =
            parseNumber(document.getElementById("nominal-50").value) || 600;
          const nominal100 =
            parseNumber(document.getElementById("nominal-100").value) || 1200;

          // Update placeholder untuk Ri 50%
          for (let i = 1; i <= 10; i++) {
            const input50 = document.querySelector(`.repeat-r50-${i}`);
            const input100 = document.querySelector(`.repeat-r100-${i}`);

            // Update placeholder berdasarkan nilai nominal
            input50.placeholder = formatNumber(nominal50, 0);
            input100.placeholder = formatNumber(nominal100, 0);

            // Jika input kosong, set nilai placeholder sebagai default
            if (!input50.value && i <= 3) {
              input50.value = formatNumber(nominal50, 0);
            }
            if (!input100.value && i <= 3) {
              // Untuk 100%, baris 1-3: 1200,0, baris 4-10: 1200,1
              const value100 = i <= 3 ? nominal100 : nominal100 + 0.1;
              input100.value = formatNumber(value100, 0);
            }
          }

          // Hitung ulang setelah update nilai
          calculateRepeatability();
        }

        // Event listener untuk input nominal
        document
          .getElementById("nominal-50")
          .addEventListener("input", updateRiPlaceholders);
        document
          .getElementById("nominal-100")
          .addEventListener("input", updateRiPlaceholders);

        // Inisialisasi perhitungan saat halaman dimuat
        document.addEventListener("DOMContentLoaded", function () {
          loadSpecs();
          updateRiPlaceholders();
          calculateRepeatability();

          // Auto-update next calibration date
          const calDateInput = document.getElementById('cal-date');
          const nextCalDateInput = document.getElementById('next-cal-date');
          if (calDateInput && nextCalDateInput) {
            calDateInput.addEventListener('change', function () {
              if (this.value) {
                const date = new Date(this.value);
                date.setFullYear(date.getFullYear() + 1);
                nextCalDateInput.value = date.toISOString().split('T')[0];
              }
            });
            // Initial trigger
            if (calDateInput.value) {
              const date = new Date(calDateInput.value);
              date.setFullYear(date.getFullYear() + 1);
              nextCalDateInput.value = date.toISOString().split('T')[0];
            }
          }
        });
      </script>

      <!-- 4. PENGUJIAN LINEARITY -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">4</span>
          PENGUJIAN LINEARITY
        </h2>

        <div class="w-full overflow-x-auto">
          <table id="linearity-table" class="w-full border border-black border-collapse mb-4">
            <!-- HEADER -->
            <thead>
              <tr class="bg-gray-200 text-center font-bold">
                <th class="border border-black w-[40px]" rowspan="2">No.</th>
                <th class="border border-black w-[100px]" rowspan="2">
                  Nominal Batu Timbang<br /><span class="font-normal unit-label">(g)</span>
                </th>
                <th class="border border-black w-[130px]" rowspan="2">
                  Massa Konvensional (Mc)<br /><span class="font-normal unit-label">(g)</span>
                </th>
                <th class="border border-black w-[150px]" colspan="2">
                  Pembacaan (Zi &amp; Ri)<br /><span class="font-normal unit-label">(g)</span>
                </th>
                <th class="border border-black w-[150px]" colspan="2">
                  Rata - Rata (Zi &amp; Ri)<br /><span class="font-normal unit-label">(g)</span>
                </th>
                <th class="border border-black w-[140px]" rowspan="2">
                  Bobot Aktual<br />(Ma = Rata-rata (RI-Zi))<br /><span class="font-normal unit-label">(g)</span>
                </th>
                <th class="border border-black w-[120px]" rowspan="2">
                  Koreksi<br />(C = Mc - Ma)<br /><span class="font-normal unit-label">(g)</span>
                </th>
                <th class="border border-black w-[120px]" rowspan="2">
                  Koreksi Absolute<br /><span class="font-normal unit-label">(g)</span>
                </th>
              </tr>
            </thead>

            <tbody>
              <!-- BARIS 1 - 20g -->
              <tr id="linearity-row-1">
                <td class="border border-black text-center font-bold" rowspan="4">
                  1
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="5">5</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-1')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="5.000050">
                  5,000050
                </td>
                <td class="border border-black px-1 text-center w-[15px]">Z‚ÇÅ</td>
                <td class="border border-black px-1 text-center w-[15px]">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center w-[15px]">Z‚ÇÅ</td>
                <td class="border border-black px-1 text-center w-[15px]">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÅ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="5,01" />
                </td>
                <td class="border border-black px-1 text-center">R‚ÇÅ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÅ'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="5,01" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 2 - 50g -->
              <tr id="linearity-row-2">
                <td class="border border-black text-center font-bold" rowspan="4">
                  2
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="10">10</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-2')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="10.000110">
                  10,000110
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÇ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÇ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÇ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="10,00" />
                </td>
                <td class="border border-black px-1 text-center">R‚ÇÇ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÇ'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="10,00" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 3 - 100g -->
              <tr id="linearity-row-3">
                <td class="border border-black text-center font-bold" rowspan="4">
                  3
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="50">50</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-3')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="50.000070">
                  50,000070
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÉ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÉ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÉ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="50,00" />
                </td>
                <td class="border border-black px-1 text-center">R‚ÇÉ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÉ'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="50,00" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 4 - 200g -->
              <tr id="linearity-row-4">
                <td class="border border-black text-center font-bold" rowspan="4">
                  4
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="100">100</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-4')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="99.999940">
                  99,999940
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÑ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÑ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÑ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="100,00" />
                </td>
                <td class="border border-black px-1 text-center">R‚ÇÑ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÑ'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="100,00" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 5 - 500g -->
              <tr id="linearity-row-5">
                <td class="border border-black text-center font-bold" rowspan="4">
                  5
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="200">200</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-5')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="199.999890">
                  199,999890
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÖ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÖ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÖ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="200,01" />
                </td>
                <td class="border border-black px-1 text-center">R‚ÇÖ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÖ'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="200,01" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 6 - 600g -->
              <tr id="linearity-row-6">
                <td class="border border-black text-center font-bold" rowspan="4">
                  6
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="500">500</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-6')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="500.000700">
                  500,000700
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÜ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÜ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÜ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="500,00" />
                </td>
                <td class="border border-black px-1 text-center">R‚ÇÜ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÜ'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="500,00" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 7 - 700g -->
              <tr id="linearity-row-7">
                <td class="border border-black text-center font-bold" rowspan="4">
                  7
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="1000">1000</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-7')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="999.998000">
                  999,998000
                </td>
                <td class="border border-black px-1 text-center">Z‚Çá</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚Çá</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚Çá</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="1000,00" />
                </td>
                <td class="border border-black px-1 text-center">R‚Çá</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚Çá'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="1000,00" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 8 - 1000g -->
              <tr id="linearity-row-8">
                <td class="border border-black text-center font-bold" rowspan="4">
                  8
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="1500">1500</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-8')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="1499.998700">
                  1499,998700
                </td>
                <td class="border border-black px-1 text-center">Z‚Çà</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚Çà</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚Çà</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0" value="" />
                </td>
                <td class="border border-black px-1 text-center">R‚Çà</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚Çà'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0" value="" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 9 - 1100g -->
              <tr id="linearity-row-9">
                <td class="border border-black text-center font-bold" rowspan="4">
                  9
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="2000">2000</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-9')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="2000.002300">
                  2000,002300000
                </td>
                <td class="border border-black px-1 text-center">Z‚Çâ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚Çâ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚Çâ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0" value="" />
                </td>
                <td class="border border-black px-1 text-center">R‚Çâ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr></tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚Çâ'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0" value="" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS 10 - 1200g -->
              <tr id="linearity-row-10">
                <td class="border border-black text-center font-bold" rowspan="4">
                  10
                </td>
                <td class="border border-black text-center relative group" rowspan="4">
                  <span class="no-decimal" data-base-weight="3000">3000</span>
                  <div class="absolute top-1 right-1 flex gap-1 no-print">
                    <button onclick="openManualInputModalWithRow(event)" title="Hitung Gabungan"
                      class="w-6 h-6 flex items-center justify-center bg-green-50 text-green-600 rounded shadow-sm border border-green-200 hover:bg-green-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14" />
                        <path d="M12 5v14" />
                      </svg>
                    </button>
                    <button onclick="openMasterLookup('linearity', 'linearity-row-10')" title="Cari dari Master"
                      class="w-6 h-6 flex items-center justify-center bg-indigo-50 text-indigo-600 rounded shadow-sm border border-indigo-200 hover:bg-indigo-600 hover:text-white transition-all duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8" />
                        <path d="m21 21-4.35-4.35" />
                      </svg>
                    </button>
                  </div>
                </td>
                <td class="border border-black text-center mc-cell" rowspan="4" data-base-weight="3000.000300">
                  3000,000300000
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÅ‚ÇÄ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black px-1 text-center">Z‚ÇÅ‚ÇÄ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
                <td class="border border-black text-center" rowspan="4">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÅ‚ÇÄ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0" value="" />
                </td>
                <td class="border border-black px-1 text-center">R‚ÇÅ‚ÇÄ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="-" readonly />
                </td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">R‚ÇÅ‚ÇÄ</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0" value="" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>
              <tr>
                <td class="border border-black px-1 text-center">Z‚ÇÅ‚ÇÄ'</td>
                <td class="border border-black px-1 text-center">
                  <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                    value="0,00" />
                </td>
                <td class="border border-black"></td>
                <td class="border border-black"></td>
              </tr>

              <!-- BARIS X (Baris terakhir untuk rata-rata X) -->
              <tr>
                <td class="border border-black" colspan="2"></td>
                <td class="border border-black bg-gray-200 text-center font-bold">
                  Y
                </td>
                <td class="border border-black" colspan="4"></td>
                <td class="border border-black bg-gray-200 text-center font-bold">
                  X
                </td>
                <td class="border border-black bg-gray-200 text-center font-bold">
                  Cmaks
                </td>
                <td class="border border-black text-center">
                  <input type="text" id="linearity-x"
                    class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                    placeholder="0,00070" readonly />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <script>
          document.addEventListener('input', function (e) {
            if (e.target.tagName !== 'INPUT' || e.target.hasAttribute('readonly')) return;

            // Ensure we are working on a table with Linearity structure
            const table = e.target.closest('table');
            if (!table || table.id !== 'linearity-table') return;

            // Find all "base rows" (rows that start a new item block, identified by rowspan on the first cell)
            const baseRows = Array.from(
              table.querySelectorAll('tbody tr')
            ).filter(tr => tr.cells.length > 0 && tr.cells[0].hasAttribute('rowspan'));

            // If no base rows found, do nothing (likely wrong table)
            if (baseRows.length === 0) return;

            let allCorrectionValues = []; // To store C values for X calculation

            baseRows.forEach((baseRow, idx) => {
              // --- 1. Identify Inputs for this Block ---
              let inputs = [];
              let currentRow = baseRow;

              // Each block spans 4 rows
              for (let i = 0; i < 4; i++) {
                if (currentRow) {
                  currentRow.querySelectorAll('input:not([readonly])').forEach(inp => inputs.push(inp));
                  currentRow = currentRow.nextElementSibling;
                }
              }

              if (inputs.length < 3) return;

              const z1 = parseNumber(inputs[0].value);
              const r1 = parseNumber(inputs[1].value);
              const r1Prime = parseNumber(inputs[2].value); // R'

              // --- 2. Determine Z2 (Next Z value) ---
              let z2 = NaN;

              if (idx < baseRows.length - 1) {
                const nextBase = baseRows[idx + 1];
                const nextZInput = nextBase.querySelector('input:not([readonly])');
                z2 = parseNumber(nextZInput?.value);
              } else {
                if (inputs.length >= 4) {
                  z2 = parseNumber(inputs[3].value);
                }
              }

              // --- 3. Perform Calculations ---
              const zAvg = (z1 + z2) / 2;
              const rAvg = (r1 + r1Prime) / 2;

              // Apply robust grounding: ensure .5 always rounds up correctly
              const d = g_decimals;
              // Using a small offset (1e-10) to ensure values like 2999.984999... (due to float noise) round to 2999.99
              const zAvgRounded = Math.round(zAvg * Math.pow(10, d) + 0.0000000001) / Math.pow(10, d);
              const rAvgRounded = Math.round(rAvg * Math.pow(10, d) + 0.0000000001) / Math.pow(10, d);

              const nominalText = baseRow.cells[1].innerText.trim();
              let mc = 0; // Initialize mc here
              let mcText = baseRow.cells[2].innerText.trim();

              // Auto-sync Mc from Master Data if missing (pastikan mengarah ke Data Pendukung)
              // Always get MC from data-base-weight for calculation, but update innerText if it's empty
              const mcFromDataset = parseFloat(baseRow.cells[2].dataset.baseWeight);
              if (!isNaN(mcFromDataset)) {
                mc = mcFromDataset;
                if (mcText === "" || mcText === "-" || mcText === "0" || mcText === "0,000000") {
                  let mcDec = 9;
                  if (g_currentUnit === 'g') mcDec = 7;
                  else if (g_currentUnit === 'mg') mcDec = 5;
                  baseRow.cells[2].innerText = formatNumber(mc, mcDec);
                }
              } else {
                // Fallback to master lookup if dataset is empty
                const master = findMasterUncertainty(nominalText);
                if (master.mc !== null) {
                  mc = master.mc;
                  let mcDec = 9;
                  if (g_currentUnit === 'g') mcDec = 7;
                  else if (g_currentUnit === 'mg') mcDec = 5;
                  baseRow.cells[2].innerText = formatNumber(mc, mcDec);
                }
              }

              // Use original averages for Ma and C calculations (internal values)
              const ma = rAvg - zAvg;
              const c = mc - ma;

              // Store C for X calculation (Only C, as Ma is total mass)
              if (!isNaN(c)) allCorrectionValues.push(c);

              // Format input values back (Daya Baca) - Only if not focused
              if (inputs[0].value !== "" && document.activeElement !== inputs[0]) inputs[0].value = formatNumber(z1);
              if (inputs[1].value !== "" && document.activeElement !== inputs[1]) inputs[1].value = formatNumber(r1);
              if (inputs[2].value !== "" && document.activeElement !== inputs[2]) inputs[2].value = formatNumber(r1Prime);
              if (inputs.length >= 4 && inputs[3].value !== "" && document.activeElement !== inputs[3]) inputs[3].value = formatNumber(z2);

              // --- 4. Update Output Fields ---
              const row1Readonlies = baseRow.querySelectorAll('input[readonly]');

              if (!isNaN(zAvgRounded)) row1Readonlies[0].value = formatNumber(zAvgRounded);
              else row1Readonlies[0].value = "-";

              if (!isNaN(ma)) row1Readonlies[1].value = formatNumber(ma, 4);
              else row1Readonlies[1].value = "-";

              if (!isNaN(c)) {
                // Hybrid Precision: 5 decimals for PDF (stored in dataset), 4 decimals for UI Display
                row1Readonlies[2].dataset.fullValue = formatNumber(c, 5);
                row1Readonlies[2].value = formatNumber(c, 4);

                row1Readonlies[3].dataset.fullValue = formatNumber(Math.abs(c), 5);
                row1Readonlies[3].value = formatNumber(Math.abs(c), 4);
              } else {
                row1Readonlies[2].value = "-";
                row1Readonlies[3].value = "-";
              }

              const row2 = baseRow.nextElementSibling;
              if (row2) {
                const row2Readonly = row2.querySelector('input[readonly]');
                if (row2Readonly) {
                  if (!isNaN(rAvgRounded)) row2Readonly.value = formatNumber(rAvgRounded);
                  else row2Readonly.value = "-";
                }
              }
            });

            // --- 5. Calculate X = ABS(MAX(C)) ---
            if (allCorrectionValues.length > 0) {
              const maxNumeric = Math.max(...allCorrectionValues); // nilai terbesar (bukan magnitudo)
              const xVal = Math.abs(maxNumeric);

              const rows = Array.from(table.querySelectorAll('tbody tr'));
              const xRow = rows.find(r =>
                Array.from(r.cells).some(c => c.innerText.trim() === 'X')
              );

              if (xRow) {
                const xInput = xRow.querySelector('input');
                if (xInput) {
                  // X follows Correction format (5 decimals per user request)
                  xInput.value = formatNumber(xVal, 5);
                }
              }
              // Store raw high precision value for LOP
              g_linearityX = xVal;
            }

            // Update Regression Table
            if (typeof updateRegressionTable === 'function') {
              updateRegressionTable();
            }

            // Update LOP
            if (typeof calculateLOP === 'function') calculateLOP();
          });
        </script>
      </section>

      <!-- 5. PENGUJIAN ECCENTRICITY -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">5</span>
          PENGUJIAN ECCENTRICITY
        </h2>

        <table id="eccentricity-table" class="w-full border border-black border-collapse mb-4">
          <thead>
            <tr class="bg-gray-200 text-center font-bold">
              <th class="border border-black px-2 py-1">Position</th>
              <th class="border border-black px-2 py-1">
                Pembacaan (R)<br /><span class="font-normal unit-label">(g)</span>
              </th>
              <th class="border border-black px-2 py-1">
                Standar Deviasi (S)<br /><span class="font-normal unit-label">(g)</span>
              </th>
              <th class="border border-black px-2 py-1">
                %RSD<br /><span class="font-normal unit-label">(g)</span>
              </th>
              <th class="border border-black px-2 py-1">
                Nominal Batu Timbang<br /><span class="font-normal unit-label">(g)</span>
              </th>
            </tr>
          </thead>
          <tbody class="text-center">
            <tr>
              <td class="border border-black px-2 py-1 text-left">Tengah (1)</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="500,0" />
              </td>
              <td class="border border-black px-2 py-1" rowspan="5">
                <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                  placeholder="0,08367" readonly />
              </td>
              <td class="border border-black px-2 py-1" rowspan="5">
                <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                  placeholder="0,01673" readonly />
              </td>
              <td class="border border-black px-2 py-1" rowspan="5">
                <input type="text" id="ecc-nominal" data-base-weight="500"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0 no-decimal"
                  placeholder="500" value="500"
                  oninput="this.dataset.baseWeight = convertFromUnit(parseNumber(this.value)); calculateEccentricity();" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1 text-left">Depan (2)</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="499,9" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1 text-left">Kiri (3)</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="500,1" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1 text-left">
                Belakang (4)
              </td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="500,1" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1 text-left">Kanan (5)</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="500,0" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1 bg-gray-200 text-left font-bold">
                Rata - rata
              </td>
              <td class="border border-black px-2 py-1 bg-gray-200 font-bold">
                <input type="text" class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                  placeholder="500,0" readonly />
              </td>
              <td class="border border-black px-2 py-1" colspan="3"></td>
            </tr>
          </tbody>
        </table>

        <!-- 6. PENGUJIAN HYSTERISIS -->

        <script>
          function calculateEccentricity() { // Calculate Eccentricity
            const eccTable = document.getElementById('eccentricity-table');
            if (!eccTable) return;

            const rows = eccTable.querySelectorAll('tbody tr');
            const readings = [];

            // Rows 0-4 are positions (Tengah, Depan, Kiri, Belakang, Kanan)
            for (let i = 0; i < 5; i++) {
              if (rows[i]) {
                const input = rows[i].querySelector('input:not([readonly])');
                if (input) {
                  readings.push(parseNumber(input.value));
                }
              }
            }

            if (readings.length === 0) return;

            // Calc Avg
            const avg = readings.reduce((a, b) => a + b, 0) / readings.length;

            // Calc SD (Sample)
            const sd = calculateSampleStandardDeviation(readings);

            // Calc %RSD
            const rsd = avg !== 0 ? (sd / avg) * 100 : 0;

            // Update UI
            // Avg Row (Row 5 - Index 5). "Rata - rata"
            // Inputs: Row 5, Cell 1 (input readonly)
            const avgInput = rows[5].querySelector('input[readonly]');
            // User Rule: "Rata-rata ... sama 0 komanya" -> Follow global formatting
            if (avgInput) avgInput.value = formatNumber(avg);

            // SD Cell (Row 0, Cell 2, rowspan 5)
            const sdInput = rows[0].cells[2].querySelector('input');
            // Match Repeatability SD format (4 decimals)
            if (sdInput) sdInput.value = formatNumber(sd, 5);

            // RSD Cell (Row 0, Cell 3, rowspan 5)
            const rsdInput = rows[0].cells[3].querySelector('input');
            // RSD is %, typically needs better precision than 1 dec if values are small. Set to 4 to match SD precision style.
            if (rsdInput) rsdInput.value = formatNumber(rsd, 5);

          }

          document.addEventListener("DOMContentLoaded", function () {
            const eccTable = document.getElementById('eccentricity-table');
            if (eccTable) {
              eccTable.querySelectorAll('input:not([readonly])').forEach(inp => {
                inp.addEventListener('input', calculateEccentricity);
              });
              // Initial calcs
              calculateEccentricity();
            }
          });
        </script>
      </section>

      <!-- 6. PENGUJIAN HYSTERISIS -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">6</span>
          PENGUJIAN HYSTERISIS
        </h2>

        <table id="hysterisis-table" class="w-full border border-black border-collapse">
          <thead>
            <tr class="bg-gray-200 text-center font-bold">
              <th class="border border-black px-2 py-1">
                Nominal Batu Timbang<br /><span class="font-normal unit-label">(g)</span>
              </th>
              <th class="border border-black px-2 py-1" colspan="2">
                Nilai p<br /><span class="font-normal unit-label">(g)</span>
              </th>
              <th class="border border-black px-2 py-1" colspan="2">
                Nilai q<br /><span class="font-normal unit-label">(g)</span>
              </th>
            </tr>
          </thead>
          <tbody class="text-center">
            <tr>
              <td class="border border-black px-2 py-1" rowspan="4">
                <input type="text" id="hyst-nominal" data-base-weight="2000"
                  class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0 no-decimal" placeholder="2000"
                  value="2000"
                  oninput="this.dataset.baseWeight = convertFromUnit(parseNumber(this.value)); calculateHysterisis();" />
              </td>
              <td class="border border-black px-2 py-1">p1</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="-" value="-" />
              </td>
              <td class="border border-black px-2 py-1">q1</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="-" value="-" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1">p2</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="-" value="-" />
              </td>
              <td class="border border-black px-2 py-1">q2</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="-" value="-" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1">p3</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="-" value="-" />
              </td>
              <td class="border border-black px-2 py-1">q3</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="-" value="-" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1">p4</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="-" value="-" />
              </td>
              <td class="border border-black px-2 py-1">q4</td>
              <td class="border border-black px-2 py-1">
                <input type="text" class="w-full border-0 text-center focus:outline-none focus:ring-0 p-0"
                  placeholder="-" value="-" />
              </td>
            </tr>
            <tr>
              <td class="border border-black px-2 py-1 bg-gray-200 font-bold">
                <em>Hysterisis</em>
              </td>
              <td class="border border-black px-2 py-1 bg-gray-200 font-bold" colspan="4">
                <input type="text" id="hysterisis-result"
                  class="w-full border-0 text-center bg-gray-100 focus:outline-none focus:ring-0 p-0"
                  placeholder="0,000" value="-" readonly />
              </td>
            </tr>
          </tbody>
        </table>

        <script>
          function calculateHysterisis() {
            const hystTable = document.getElementById('hysterisis-table');
            if (!hystTable) return;

            const rows = hystTable.querySelectorAll('tbody tr');

            let sumP = 0;
            let sumQ = 0;
            let hasNumericInput = false;

            for (let i = 0; i < 4; i++) {
              if (rows[i]) {
                const inputs = rows[i].querySelectorAll('input:not([readonly])');
                // Index mapping: 
                // Row 0: Nominal(0), P1(1), Q1(2)
                // Rows 1-3: Pi(0), Qi(1)
                const pIdx = (i === 0) ? 1 : 0;
                const qIdx = (i === 0) ? 2 : 1;

                if (inputs[pIdx] && inputs[pIdx].value.trim() !== "" && inputs[pIdx].value.trim() !== "-") {
                  sumP += parseNumber(inputs[pIdx].value);
                  hasNumericInput = true;
                }
                if (inputs[qIdx] && inputs[qIdx].value.trim() !== "" && inputs[qIdx].value.trim() !== "-") {
                  sumQ += parseNumber(inputs[qIdx].value);
                  hasNumericInput = true;
                }
              }
            }

            const result = (sumP - sumQ) / 4;

            // Result Row
            const resInput = document.getElementById("hysterisis-result");
            if (resInput) {
              resInput.value = hasNumericInput ? formatNumber(result, 3) : "-";
            }
          }

          document.addEventListener("DOMContentLoaded", function () {
            const hystTable = document.getElementById('hysterisis-table');
            if (hystTable) {
              hystTable.querySelectorAll('input:not([readonly])').forEach(inp => {
                inp.addEventListener('input', calculateHysterisis);
              });
            }
          });
        </script>
      </section>

      <!-- 7. PERHITUNGAN KETIDAKPASTIAN (U95) -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">7</span>
          PERHITUNGAN KETIDAKPASTIAN (U95)
        </h2>

        <!-- Perhitungan Regresi Linear -->
        <p class="font-bold mb-1">Perhitungan Regresi Linear</p>
        <p class="mb-2 italic">Perhitungan Secara Manual</p>

        <div class="w-full overflow-x-auto mb-4">
          <table id="regression-table" class="w-full border border-black border-collapse mb-4">
            <thead>
              <tr class="bg-gray-200 text-center font-bold">
                <th class="border border-black px-2 py-1 w-[60px]">No.</th>
                <th class="border border-black px-2 py-1 w-[10px]">x</th>
                <th class="border border-black px-2 py-1 w-[10px]">x¬≤</th>
                <th class="border border-black px-2 py-1 w-[10px]">y</th>
                <th class="border border-black px-2 py-1 w-[10px]">y¬≤</th>
                <th class="border border-black px-2 py-1 w-[10px]">x.y</th>
              </tr>
            </thead>
            <tbody class="text-center">
              <!-- Baris 1 -->
              <tr>
                <td class="border border-black px-2 py-1">1</td>
                <td class="border border-black px-2 py-1">20,00000000</td>
                <td class="border border-black px-2 py-1">400,00000000</td>
                <td class="border border-black px-2 py-1">19,99996000</td>
                <td class="border border-black px-2 py-1">399,99840002</td>
                <td class="border border-black px-2 py-1">399,99920000</td>
              </tr>
              <!-- Baris 2 -->
              <tr>
                <td class="border border-black px-2 py-1">2</td>
                <td class="border border-black px-2 py-1">50,00000000</td>
                <td class="border border-black px-2 py-1">2.500,00000000</td>
                <td class="border border-black px-2 py-1">50,00007000</td>
                <td class="border border-black px-2 py-1">2.500,00700005</td>
                <td class="border border-black px-2 py-1">2.500,00350000</td>
              </tr>
              <!-- Baris 3 -->
              <tr>
                <td class="border border-black px-2 py-1">3</td>
                <td class="border border-black px-2 py-1">100,00000000</td>
                <td class="border border-black px-2 py-1">10.000,00000000</td>
                <td class="border border-black px-2 py-1">99,99994000</td>
                <td class="border border-black px-2 py-1">9.999,98800004</td>
                <td class="border border-black px-2 py-1">9.999,99400000</td>
              </tr>
              <!-- Baris 4 -->
              <tr>
                <td class="border border-black px-2 py-1">4</td>
                <td class="border border-black px-2 py-1">200,00000000</td>
                <td class="border border-black px-2 py-1">40.000,00000000</td>
                <td class="border border-black px-2 py-1">199,99989000</td>
                <td class="border border-black px-2 py-1">39.999,95600012</td>
                <td class="border border-black px-2 py-1">39.999,97800000</td>
              </tr>
              <!-- Baris 5 -->
              <tr>
                <td class="border border-black px-2 py-1">5</td>
                <td class="border border-black px-2 py-1">500,00000000</td>
                <td class="border border-black px-2 py-1">250.000,00000000</td>
                <td class="border border-black px-2 py-1">500,00070000</td>
                <td class="border border-black px-2 py-1">250.000,70000490</td>
                <td class="border border-black px-2 py-1">250.000,35000000</td>
              </tr>
              <!-- Baris 6 -->
              <tr>
                <td class="border border-black px-2 py-1">6</td>
                <td class="border border-black px-2 py-1">600,00000000</td>
                <td class="border border-black px-2 py-1">360.000,00000000</td>
                <td class="border border-black px-2 py-1">600,00064000</td>
                <td class="border border-black px-2 py-1">360.000,76800410</td>
                <td class="border border-black px-2 py-1">360.000,38400000</td>
              </tr>
              <!-- Baris 7 -->
              <tr>
                <td class="border border-black px-2 py-1">7</td>
                <td class="border border-black px-2 py-1">700,00000000</td>
                <td class="border border-black px-2 py-1">490.000,00000000</td>
                <td class="border border-black px-2 py-1">700,00059000</td>
                <td class="border border-black px-2 py-1">490.000,82600038</td>
                <td class="border border-black px-2 py-1">490.000,41300000</td>
              </tr>
              <!-- Baris 8 -->
              <tr>
                <td class="border border-black px-2 py-1">8</td>
                <td class="border border-black px-2 py-1">1.000,10000000</td>
                <td class="border border-black px-2 py-1">1.000.200,01000000</td>
                <td class="border border-black px-2 py-1">999,99800000</td>
                <td class="border border-black px-2 py-1">999.996,00004400</td>
                <td class="border border-black px-2 py-1">1.000.097,99980000</td>
              </tr>
              <!-- Baris 9 -->
              <tr>
                <td class="border border-black px-2 py-1">9</td>
                <td class="border border-black px-2 py-1">1.100,10000000</td>
                <td class="border border-black px-2 py-1">1.210.220,01000000</td>
                <td class="border border-black px-2 py-1">1.099,99794000</td>
                <td class="border border-black px-2 py-1">1.209.995,46802440</td>
                <td class="border border-black px-2 py-1">1.210.107,73379400</td>
              </tr>
              <!-- Baris 10 -->
              <tr>
                <td class="border border-black px-2 py-1">10</td>
                <td class="border border-black px-2 py-1">1.200,10000000</td>
                <td class="border border-black px-2 py-1">1.440.240,01000000</td>
                <td class="border border-black px-2 py-1">1.199,99789000</td>
                <td class="border border-black px-2 py-1">1.439.994,93600450</td>
                <td class="border border-black px-2 py-1">1.440.117,46778900</td>
              </tr>
              <!-- Baris JUMLAH -->
              <tr class="bg-gray-100 font-bold">
                <td class="border border-black px-2 py-1">Jumlah</td>
                <td class="border border-black px-2 py-1">5.470,300000000</td>
                <td class="border border-black px-2 py-1">4.803.560,030000000</td>
                <td class="border border-black px-2 py-1">5.469,995620000</td>
                <td class="border border-black px-2 py-1">4.802.888,647413970</td>
                <td class="border border-black px-2 py-1">4.803.224,323083000</td>
              </tr>
              <!-- Baris RATA-RATA -->
              <tr class="bg-gray-100 font-bold">
                <td class="border border-black px-2 py-1">Rata-rata</td>
                <td class="border border-black px-2 py-1">547,030000000</td>
                <td class="border border-black px-2 py-1">480.356,003000000</td>
                <td class="border border-black px-2 py-1">546,999562000</td>
                <td class="border border-black px-2 py-1">480.288,864741397</td>
                <td class="border border-black px-2 py-1">480.322,432308300</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Rumus dan Hasil Regresi -->
        <div class="mb-6">
          <p class="font-bold mb-2">Rumus Regresi Linear:</p>
          <div class="pl-4 mb-2">
            <p class="mb-1">Menghitung Rata - Rata, a = »≥ - (b¬∑xÃÑ) = <span id="reg-a" class="font-bold">-</span></p>
            <p class="mb-1">Menghitung Jumlah, b = (n¬∑Œ£xy - Œ£x¬∑Œ£y) / (n¬∑Œ£x¬≤ - (Œ£x)¬≤) = <span id="reg-b"
                class="font-bold">-</span></p>
          </div>
        </div>

        <!-- GRAFIK REGRESI -->
        <div class="mb-6 p-4 border border-gray-300 rounded shadow-sm">
          <p class="font-bold mb-4 text-green-700">Perhitungan Secara Otomatis (Grafik)</p>
          <div class="w-full max-w-[900px] h-[550px] mx-auto bg-white p-4">
            <canvas id="regressionChart"></canvas>
          </div>
        </div>

        <p class="font-bold mb-2">Tabel Perhitungan U<sub>95</sub> (maks)</p>
        <div class="w-full overflow-x-auto mb-4">
          <table id="uncertainty-table" class="min-w-[1400px] border border-black border-collapse table-fixed">

            <!-- HEADER ATAS -->
            <thead>
              <tr class="text-center font-bold bg-gray-200">
                <th rowspan="2" class="border border-black w-[40px]">No.</th>
                <th rowspan="2" class="border border-black w-[120px]">Nominal Batu Timbang</th>
                <th colspan="1" class="border border-black">y</th>
                <th colspan="1" class="border border-black">x</th>
                <th colspan="6" class="border border-black"> </th>
                <th colspan="3" class="border border-black"> </th>
              </tr>

              <tr class="text-center font-bold bg-gray-200">
                <th class="border border-black w-[130px]">Massa Konvensional</th>
                <th class="border border-black w-[110px]">Bobot Aktual</th>
                <th class="border border-black w-[110px]">U<sub>1</sub></th>
                <th class="border border-black w-[110px]">U<sub>2</sub></th>
                <th class="border border-black w-[110px]">U<sub>3</sub></th>
                <th class="border border-black w-[110px]">U<sub>4</sub></th>
                <th class="border border-black w-[110px]">U<sub>5</sub></th>
                <th class="border border-black w-[110px]">SSR</th>
                <th class="border border-black w-[110px]">U<sub>6</sub></th>
                <th class="border border-black w-[110px]">U<sub>c</sub></th>
                <th class="border border-black w-[110px]">U<sub>95</sub></th>
              </tr>
            </thead>

            <!-- BODY -->
            <tbody class="text-center">

              <!-- ROW 1 -->
              <tr>
                <td class="border border-black">1</td>
                <td class="border border-black">20</td>
                <td class="border border-black">19,999600</td>
                <td class="border border-black">20,00</td>
                <td class="border border-black">0,000023000</td>
                <td class="border border-black">0,015275252</td>
                <td class="border border-black">0,002886751</td>
                <td class="border border-black">0,000020000</td>
                <td class="border border-black">0,000011547</td>
                <td class="border border-black">0,000354893</td>
                <td class="border border-black">0,000022181</td>
                <td class="border border-black">0,015545682</td>
                <td class="border border-black">0,031091363</td>
              </tr>

              <!-- ROW 2 -->
              <tr>
                <td class="border border-black">2</td>
                <td class="border border-black">50</td>
                <td class="border border-black">50,000070</td>
                <td class="border border-black">50,00</td>
                <td class="border border-black">0,000028000</td>
                <td class="border border-black">0,015275252</td>
                <td class="border border-black">0,002886751</td>
                <td class="border border-black">0,000024000</td>
                <td class="border border-black">0,000028868</td>
                <td class="border border-black">0,000253635</td>
                <td class="border border-black">0,000015852</td>
                <td class="border border-black">0,015545710</td>
                <td class="border border-black">0,031091421</td>
              </tr>

              <!-- ROW 3 -->
              <tr>
                <td class="border border-black">3</td>
                <td class="border border-black">100</td>
                <td class="border border-black">99,999940</td>
                <td class="border border-black">100,00</td>
                <td class="border border-black">0,000046000</td>
                <td class="border border-black">0,015275252</td>
                <td class="border border-black">0,002886751</td>
                <td class="border border-black">0,000040000</td>
                <td class="border border-black">0,000057735</td>
                <td class="border border-black">0,000129613</td>
                <td class="border border-black">0,000008101</td>
                <td class="border border-black">0,015545861</td>
                <td class="border border-black">0,031091721</td>
              </tr>

              <!-- ROW 4 -->
              <tr>
                <td class="border border-black">4</td>
                <td class="border border-black">200</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
              </tr>

              <!-- ROW 5 -->
              <tr>
                <td class="border border-black">5</td>
                <td class="border border-black">500</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
              </tr>

              <!-- ROW 6 -->
              <tr>
                <td class="border border-black">6</td>
                <td class="border border-black">600</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
              </tr>

              <!-- ROW 7 -->
              <tr>
                <td class="border border-black">7</td>
                <td class="border border-black">700</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
              </tr>

              <!-- ROW 8 -->
              <tr>
                <td class="border border-black">8</td>
                <td class="border border-black">1000</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
              </tr>

              <!-- ROW 9 -->
              <tr>
                <td class="border border-black">9</td>
                <td class="border border-black">1100</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
              </tr>

              <!-- ROW 10 -->
              <tr>
                <td class="border border-black">10</td>
                <td class="border border-black">1200</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
                <td class="border border-black">-</td>
              </tr>

              <!-- TOTAL -->
              <tr class="bg-gray-200 font-bold">
                <td colspan="12" class="border border-black text-right pr-4">
                  U<sub>95</sub>(maks)
                </td>
                <td id="u95-max-val" class="border border-black">0,03156355</td>
              </tr>

            </tbody>
          </table>
        </div>
      </section>

      <!-- 8. PERHITUNGAN LIMIT OF PERFORMANCE (LOP)/F -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">8</span>
          PERHITUNGAN LIMIT OF PERFORMANCE (LOP)/F
        </h2>
        <p class="font-bold mb-1">F = 2.26 x (Smaks + Cmaks + U95 <em>(maks)</em>)</p>
        <p id="lop-display" class="font-normal mb-1">F = 0,00000 g</p>
      </section>

      <!-- 9. ACUAN -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">9</span>
          ACUAN
        </h2>
        <p class="mb-2" id="acuan-val">Protap Kalibrasi dan Verifikasi Harian Timbangan Elektronik (QASS-P-040)</p>
      </section>

      <!-- 10. KESIMPULAN -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">10</span>
          KESIMPULAN
        </h2>
        <div class="mb-2">
          <select id="kesimpulan-val" class="border border-gray-300 rounded px-2 py-1">
            <option value="Memenuhi Syarat">Memenuhi Syarat</option>
            <option value="Tidak Memenuhi Syarat">Tidak Memenuhi Syarat</option>
          </select>
        </div>
      </section>

      <!-- 11. KALIBRASI ULANG -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">11</span>
          KALIBRASI ULANG
        </h2>
        <div class="mb-2">
          <input type="date" id="next-cal-date" class="border border-gray-300 rounded px-2 py-1" />
        </div>
      </section>

      <!-- 12. KETERANGAN -->
      <section class="mb-8">
        <h2 class="font-bold mb-3 text-sm flex items-center gap-2">
          <span class="bg-black text-white px-2 py-0.5 rounded text-[10px]">12</span>
          KETERANGAN
        </h2>
        <div class="mb-2">
          <input type="text" id="keterangan-val" value="NA"
            class="border border-gray-300 rounded px-2 py-1 w-full max-w-md" />
        </div>
      </section>
  </div>
</body>

</html>
<script>
  function updateRegressionTable() {
    const linTable = document.getElementById('linearity-table');
    const regTable = document.getElementById('regression-table');
    if (!linTable || !regTable) return;

    const allBaseRows = Array.from(linTable.querySelectorAll('tbody tr')).filter(r =>
      r.cells.length >= 10 && r.cells[0].hasAttribute('rowspan') && r.cells[0].innerText.trim().match(/^\d+$/)
    );

    const regRows = regTable.querySelectorAll('tbody tr');
    let sumX = 0, sumX2 = 0, sumY = 0, sumY2 = 0, sumXY = 0, count = 0;

    regRows.forEach((regRow, idx) => {
      const regCells = regRow.cells;
      if (regRow.classList.contains('bg-gray-100')) return;

      if (idx < allBaseRows.length) {
        const row = allBaseRows[idx];
        const valY = parseFloat(row.cells[2]?.dataset.baseWeight); // Mc from dataset

        let valX = 0;
        let hasX = false;
        const maInput = row.cells[7]?.querySelector('input');
        if (maInput && maInput.value.trim() !== "" && maInput.value.trim() !== "-") {
          valX = parseNumber(maInput.value);
          hasX = true;
        }

        if (hasX && !isNaN(valY) && valY !== 0) {
          const x = valX;
          const y = valY;
          const xSq = x * x;
          const ySq = y * y;
          const xy = x * y;

          if (regCells.length >= 6) {
            regCells[1].innerText = formatRegressionNumber(x, 9);
            regCells[2].innerText = formatRegressionNumber(xSq, 9);
            regCells[3].innerText = formatRegressionNumber(y, 9);
            regCells[4].innerText = formatRegressionNumber(ySq, 9);
            regCells[5].innerText = formatRegressionNumber(xy, 9);
          }

          sumX += x;
          sumX2 += xSq;
          sumY += y;
          sumY2 += ySq;
          sumXY += xy;
          count++;
        } else {
          for (let k = 1; k < 6; k++) if (regCells[k]) regCells[k].innerText = "";
        }
      } else {
        for (let k = 1; k < 6; k++) if (regCells[k]) regCells[k].innerText = "";
      }
    });

    if (count > 0) {
      const sumRow = Array.from(regRows).find(r => r.innerText.includes('Jumlah'));
      const avgRow = Array.from(regRows).find(r => r.innerText.includes('Rata-rata'));

      if (sumRow) {
        sumRow.cells[1].innerText = formatRegressionNumber(sumX, 9);
        sumRow.cells[2].innerText = formatRegressionNumber(sumX2, 9);
        sumRow.cells[3].innerText = formatRegressionNumber(sumY, 9);
        sumRow.cells[4].innerText = formatRegressionNumber(sumY2, 9);
        sumRow.cells[5].innerText = formatRegressionNumber(sumXY, 9);
      }
      if (avgRow) {
        avgRow.cells[1].innerText = formatRegressionNumber(sumX / count, 9);
        avgRow.cells[2].innerText = formatRegressionNumber(sumX2 / count, 9);
        avgRow.cells[3].innerText = formatRegressionNumber(sumY / count, 9);
        avgRow.cells[4].innerText = formatRegressionNumber(sumY2 / count, 9);
        avgRow.cells[5].innerText = formatRegressionNumber(sumXY / count, 9);
      }
    }

    if (typeof calculateUncertainty === 'function') calculateUncertainty();
  }

  // --- MPE TABLE (From OIML R-111, in mg, indexed by Grams) ---
  const MPE_TABLE = {
    'E1': { 50000: 25, 20000: 10, 10000: 5, 5000: 2.5, 2000: 1, 1000: 0.5, 500: 0.25, 200: 0.1, 100: 0.05, 50: 0.03, 20: 0.025, 10: 0.02, 5: 0.016, 2: 0.012, 1: 0.01, 0.5: 0.008, 0.2: 0.006, 0.1: 0.005, 0.05: 0.004, 0.02: 0.003, 0.01: 0.003, 0.005: 0.003, 0.002: 0.003, 0.001: 0.003 },
    'E2': { 1000000: 1600, 500000: 800, 200000: 300, 100000: 160, 50000: 80, 20000: 30, 10000: 16, 5000: 8, 2000: 3, 1000: 1.6, 500: 0.8, 200: 0.3, 100: 0.16, 50: 0.1, 20: 0.08, 10: 0.06, 5: 0.05, 2: 0.04, 1: 0.03, 0.5: 0.025, 0.2: 0.02, 0.1: 0.016, 0.05: 0.012, 0.02: 0.01, 0.01: 0.008, 0.005: 0.006, 0.002: 0.006, 0.001: 0.006 },
    'F1': { 5000000: 25000, 2000000: 10000, 1000000: 5000, 500000: 2500, 200000: 1000, 100000: 500, 50000: 250, 20000: 100, 10000: 50, 5000: 25, 2000: 10, 1000: 5, 500: 2.5, 200: 1, 100: 0.5, 50: 0.3, 20: 0.25, 10: 0.2, 5: 0.16, 2: 0.12, 1: 0.08, 0.5: 0.06, 0.2: 0.05, 0.1: 0.04, 0.05: 0.03, 0.02: 0.025, 0.01: 0.025, 0.005: 0.02, 0.002: 0.02, 0.001: 0.02 },
    'F2': { 5000000: 80000, 2000000: 30000, 1000000: 16000, 500000: 8000, 200000: 3000, 100000: 1600, 50000: 800, 20000: 300, 10000: 160, 5000: 80, 2000: 30, 1000: 16, 500: 8, 200: 3, 100: 1.6, 50: 1, 20: 0.8, 10: 0.6, 5: 0.5, 2: 0.4, 1: 0.3, 0.5: 0.2, 0.2: 0.16, 0.1: 0.12, 0.05: 0.1, 0.02: 0.08, 0.01: 0.08, 0.005: 0.06, 0.002: 0.06, 0.001: 0.06 },
    'M1': { 5000000: 250000, 2000000: 100000, 1000000: 50000, 500000: 25000, 200000: 10000, 100000: 5000, 50000: 2500, 20000: 1000, 10000: 500, 5000: 250, 2000: 100, 1000: 50, 500: 25, 200: 10, 100: 5, 50: 3, 20: 2.5, 10: 2, 5: 1.6, 2: 1.2, 1: 1, 0.5: 0.8, 0.2: 0.6, 0.1: 0.5, 0.05: 0.4, 0.02: 0.3, 0.01: 0.25, 0.005: 0.2, 0.002: 0.2, 0.001: 0.2 },
    'M1-2': { 5000000: 500000, 2000000: 200000, 1000000: 100000, 500000: 50000, 200000: 20000, 100000: 10000, 50000: 5000 },
    'M2': { 5000000: 800000, 2000000: 300000, 1000000: 160000, 500000: 80000, 200000: 30000, 100000: 16000, 50000: 8000, 20000: 3000, 10000: 1600, 5000: 800, 2000: 300, 1000: 160, 500: 80, 200: 30, 100: 16, 50: 10, 20: 8, 10: 6, 5: 5, 2: 4, 1: 3, 0.5: 2.5, 0.2: 2, 0.1: 1.6 },
    'M2-3': { 5000000: 1600000, 2000000: 600000, 1000000: 300000, 500000: 160000, 200000: 60000, 100000: 30000, 50000: 16000 },
    'M3': { 5000000: 2500000, 2000000: 1000000, 1000000: 500000, 500000: 250000, 200000: 100000, 100000: 50000, 50000: 25000, 20000: 10000, 10000: 5000, 5000: 2500, 2000: 1000, 1000: 500, 500: 250, 200: 100, 100: 50, 50: 30, 20: 25, 10: 20, 5: 16, 2: 12, 1: 10 }
  };

  function getMPEWithBreakdown(nominalG, className) {
    if (!className) return 0;
    const cls = className.toUpperCase().trim();
    if (!MPE_TABLE[cls]) return 0;

    const table = MPE_TABLE[cls];
    const availableNominals = Object.keys(table)
      .map(Number)
      .sort((a, b) => b - a); // Sort descending for greedy approach

    let remaining = nominalG;
    let totalMPE = 0;

    // Greedy decomposition using standard OIML nominals available in the table
    for (const nom of availableNominals) {
      while (remaining >= nom - 0.000001) { // 0.000001 to handle float precision
        totalMPE += table[nom];
        remaining -= nom;
      }
    }

    return totalMPE;
  }


  function calculateUncertainty() {
    const uncTable = document.getElementById('uncertainty-table');
    const regTable = document.getElementById('regression-table');
    if (!uncTable || !regTable) return;

    const certU95 = parseNumber(document.getElementById('cert-u95')?.value) || 0;
    const stdMax = g_stdMax || parseNumber(document.getElementById('std-max')?.value) || 0;
    const resolution = getResolutionFromSpecs();

    const U1 = certU95 / 2;
    const U2 = stdMax / Math.sqrt(10);
    const U3 = (0.05 * resolution) / Math.sqrt(3);

    const xVals = [];
    const yVals = [];
    const regRows = Array.from(regTable.querySelectorAll('tbody tr')).filter(r => !r.classList.contains('bg-gray-100'));

    regRows.forEach(r => {
      const xText = r.cells[1].innerText.trim();
      const yText = r.cells[3].innerText.trim();
      if (xText !== "" && yText !== "") {
        const xv = parseNumber(xText);
        const yv = parseNumber(yText);
        if (!isNaN(xv) && !isNaN(yv)) {
          xVals.push(xv);
          yVals.push(yv);
        }
      }
    });

    const n = xVals.length;
    let slope = 0, intercept = 0, globalS = 0;

    if (n > 2) {
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
      for (let i = 0; i < n; i++) {
        sumX += xVals[i];
        sumY += yVals[i];
        sumXY += xVals[i] * yVals[i];
        sumX2 += xVals[i] * xVals[i];
      }

      const denom = n * sumX2 - sumX * sumX;
      if (denom !== 0) {
        slope = (n * sumXY - sumX * sumY) / denom;
        intercept = (sumY - slope * sumX) / n;
      }

      let ssrSum = 0;
      for (let i = 0; i < n; i++) {
        const pred = intercept + slope * xVals[i];
        ssrSum += Math.pow(yVals[i] - pred, 2);
      }
      // U6 calculation as requested: sqrt(SSR / 8)
      globalS = Math.sqrt(ssrSum / 8);

      document.getElementById('reg-a').innerText = formatNumber(intercept, 9);
      document.getElementById('reg-b').innerText = formatNumber(slope, 9);

      const yBar = sumY / n;
      let ssy = 0;
      for (let i = 0; i < n; i++) ssy += Math.pow(yVals[i] - yBar, 2);
      const rSquared = ssy !== 0 ? 1 - (ssrSum / ssy) : 0;
      updateChart(xVals, yVals, slope, intercept, rSquared);
    } else {
      document.getElementById('reg-a').innerText = "-";
      document.getElementById('reg-b').innerText = "-";
      updateChart([], [], 0, 0, 0);
    }

    const uncRows = uncTable.querySelectorAll('tbody tr');
    const maxU95s = [];
    const linTable = document.getElementById('linearity-table');
    const linRows = linTable ? Array.from(linTable.querySelectorAll('tbody tr')).filter(r =>
      r.cells.length >= 10 && r.cells[0].hasAttribute('rowspan') && r.cells[0].innerText.trim().match(/^\d+$/)
    ) : [];

    regRows.forEach((regRow, idx) => {
      if (idx >= uncRows.length) return;
      const uRow = uncRows[idx];
      const cells = uRow.cells;
      const xText = regRow.cells[1].innerText.trim();
      const xVal = parseNumber(xText);
      const yVal = parseNumber(regRow.cells[3].innerText);

      let nominalVal = 0;
      let nominalDisplay = "";
      if (linRows[idx]) {
        const nomCell = linRows[idx].cells[1];
        const nomSpan = nomCell.querySelector('span.no-decimal');
        nominalVal = parseFloat(nomSpan ? nomSpan.dataset.baseWeight : nomCell.dataset.baseWeight) || 0;
        nominalDisplay = (nomSpan ? nomSpan.innerText : nomCell.innerText).trim();
      }

      // If no nominal, we can't even show the row basics
      if (!nominalDisplay && !xText) {
        for (let c = 1; c < cells.length; c++) cells[c].innerText = "";
        return;
      }

      let rowU1 = certU95 / 2;
      const resultU = findMasterUncertainty(nominalDisplay);

      if (resultU.u !== null) rowU1 = resultU.u / 2;

      // Explicit override from dataset (if user manually selected via modal) - takes precedence
      if (linRows[idx] && linRows[idx].dataset.certU) {
        const rowCertU = parseFloat(linRows[idx].dataset.certU.replace(',', '.'));
        if (!isNaN(rowCertU) && rowCertU > 0) {
          rowU1 = rowCertU / 2;
        }
      }

      let mcDec = 9;
      if (g_currentUnit === 'g') mcDec = 6;
      else if (g_currentUnit === 'mg') mcDec = 3;

      cells[1].innerText = formatNumber(nominalVal, 0);
      cells[2].innerText = isNaN(yVal) ? "-" : formatNumber(yVal, mcDec);
      cells[3].innerText = isNaN(xVal) ? "-" : formatNumber(xVal, g_decimals); // Aligned with Daya Baca
      cells[4].innerText = formatNumber(rowU1, 9);
      cells[5].innerText = formatNumber(U2, 9);
      cells[6].innerText = formatNumber(U3, 9);

      // 1. Identify global default class from Section 1B (Data Batu Timbang yang Digunakan)
      let globalDefaultClass = "";
      for (let i = 1; i <= 3; i++) {
        const idVal = document.getElementById(`support-id-${i}`)?.value;
        const classVal = document.getElementById(`support-class-${i}`)?.value;
        if (idVal && classVal && classVal.trim() !== "") {
          globalDefaultClass = classVal;
          break;
        }
      }

      // U4: 8% * MPE (Buoyancy)
      // Highest Priority: Use the specific class stored in the row dataset (from Search/Manual Submit)
      let targetClass = linRows[idx] ? linRows[idx].dataset.certKelas : null;

      // Secondary Priority: Match based on certificate/ID from Data Pendukung (Section 1B)
      if (!targetClass) {
        targetClass = resultU.kelas;
        if (!targetClass) {
          for (let i = 1; i <= 3; i++) {
            const idInput = document.getElementById(`support-id-${i}`);
            const classInput = document.getElementById(`support-class-${i}`);
            if (idInput && classInput && idInput.value !== "") {
              const res = findMasterUncertainty(nominalDisplay);
              if (res.kelas) targetClass = res.kelas;
            }
          }
        }
      }

      // Tertiary Priority: Check if nominalDisplay literally contains one of the support IDs
      if (!targetClass) {
        for (let i = 1; i <= 3; i++) {
          const idVal = document.getElementById(`support-id-${i}`)?.value;
          const classVal = document.getElementById(`support-class-${i}`)?.value;
          if (idVal && classVal && nominalDisplay.includes(idVal)) {
            targetClass = classVal;
          }
        }
      }

      // Final Fallback: First active class from Section 1B, then "F1" (Safe Global Default)
      if (!targetClass) {
        targetClass = globalDefaultClass || "F1";
      }

      const mpeValue = getMPEWithBreakdown(nominalVal, targetClass);
      const u4 = 0.08 * (mpeValue / 1000); // 8% of MPE (converted to grams)
      cells[7].innerText = formatNumber(u4, 9);

      // U5: 1 ppm Buoyancy
      const u5 = (1.0e-6 * nominalVal) / Math.sqrt(3);
      cells[8].innerText = formatNumber(u5, 9);

      // SSR, U6, Uc, U95: Only if regression data exists
      if (isNaN(xVal) || isNaN(yVal) || n <= 2) {
        cells[9].innerText = "-";
        cells[10].innerText = "-";
        cells[11].innerText = "-";
        cells[12].innerText = "-";
        return;
      }

      // SSR column: Row-wise squared residual
      // Formula: (Yi - a - bXi)^2
      const localRes = (yVal - intercept - (slope * xVal));
      const ssrRow = Math.pow(localRes, 2);
      cells[9].innerText = formatNumber(ssrRow, 9);

      // U6: Regression component (SSR_row / 16 per reference table)
      // Reference says U6 is (SSR / 16). We assume this is the standard uncertainty.
      const u6 = ssrRow / 16;
      cells[10].innerText = formatNumber(u6, 9);

      // Uc: Combined standard uncertainty
      // Excel Formula: SQRT(U1^2 + U2^2 + U3^2 + U4^2 + U5^2 + U6^2)
      // NOTE: If U6 column in Excel displays (SSR/16), then squaring it in the formula 
      // is correct ONLY if (SSR/16) is the standard uncertainty, not the variance.
      const sumSq = Math.pow(rowU1, 2) + Math.pow(U2, 2) + Math.pow(U3, 2) + Math.pow(u4, 2) + Math.pow(u5, 2) + Math.pow(u6, 2);
      const Uc = Math.sqrt(sumSq);

      console.log(`Row ${idx + 1} (${nominalVal}g) components:`, {
        u1: rowU1,
        u2: U2,
        u3: U3,
        u4: u4,
        u5: u5,
        u6: u6,
        sumSq: sumSq,
        Uc: Uc
      });

      cells[11].innerText = formatNumber(Uc, 9);

      // U95: Expanded uncertainty (k=2)
      const U95 = Uc * 2;
      cells[12].innerText = formatNumber(U95, 9);
      maxU95s.push(U95);
    });

    const totalRow = Array.from(uncRows).find(r => r.innerText.includes("U95"));
    if (totalRow) {
      const maxVal = Math.max(...maxU95s, 0);
      const valCell = totalRow.cells[totalRow.cells.length - 1];
      if (valCell) valCell.innerText = formatNumber(maxVal, 9);

      // Store raw high precision value for LOP
      g_u95Max = maxVal;
    }

    // Trigger LOP calculation
    if (typeof calculateLOP === 'function') calculateLOP();
  }

  // Calculate Limit of Performance (LOP) / F
  function calculateLOP() {
    console.log('üéØ [LOP] Calculating Limit of Performance (Raw Mode)...');

    // Use global high-precision variables
    const smaks = g_stdMax;
    const cmaks = g_linearityX;
    const u95maks = g_u95Max;

    console.log(`üìä [LOP] Smaks = ${smaks}, Cmaks = ${cmaks}, U95(maks) = ${u95maks}`);

    // Calculate F = 2.26 √ó (Smaks + Cmaks + u95maks)
    // No more rounding logic applied to the math, just for the display
    const f = 2.26 * (smaks + cmaks + u95maks);

    const resolution = getResolutionFromSpecs();
    const decimals = resolution > 0 ? Math.max(0, -Math.floor(Math.log10(resolution))) : 5;

    const lopDisplay = document.getElementById('lop-display');
    if (lopDisplay) {
      // Direct raw calculation display forced to 5 decimals
      lopDisplay.innerText = "F = " + formatNumber(f, 5) + " g";
    }
    console.log(`‚úÖ [LOP] Updated display: F = ${formatNumber(f, 5)} g`);
  }

  // Master Lookup for U1 (Global across all master data)
  function findMasterUncertainty(targetDisplay, depth = 0) {
    if (!targetDisplay || depth > 5) return { u: null, mc: null, kelas: "" };
    const targetStr = targetDisplay.toString().toLowerCase().trim();
    console.log(`üîç [U1 DEBUG] Lookup: "${targetDisplay}" (Depth: ${depth})`);

    try {
      const whitelistRaw = JSON.parse(localStorage.getItem('masterDataSupport') || '[]');
      const filteredMaster = getValidMasterData();

      if (filteredMaster.length === 0) return { u: null, mc: null, kelas: "" };

      const allWeights = filteredMaster.flatMap(set => (set.weights || []).map(w => ({
        ...w,
        date: set.tanggal,
        kelas: set.kelas,
        parentIdentitas: (set.noIdentitas || set.id || "").trim().toUpperCase()
      })));

      const rawTargetNum = parseNumber(targetDisplay);
      const targetMark = targetStr.includes('*');

      // Determine target unit for strict filtering
      const isTargetMg = targetStr.includes('mg');
      const isTargetKg = targetStr.includes('kg');
      const isTargetG = !isTargetMg && !isTargetKg;

      // 1. Direct Match
      const matches = allWeights.filter(w => {
        // A) Numeric Match
        const baseNom = parseNumber(w.nominal);
        const wUnit = (w.unit || "").toLowerCase().trim();
        const unitMult = (wUnit === 'kg' ? 1000 : (wUnit === 'mg' ? 0.001 : 1));
        const totalGram = baseNom * unitMult;
        const isNumericMatch = Math.abs(totalGram - rawTargetNum) < 0.001 && (!!w.mark === targetMark);

        // B) String Column Match (Strictly Unit-Aware)
        let isStringMatch = false;
        if (isTargetG) {
          if (w.nomG && w.nomG !== "-" && parseNumber(w.nomG) === rawTargetNum && (w.nomG.includes('*') === targetMark)) isStringMatch = true;
          // Accept Kg columns for large Gram targets (e.g. 1000g == 1kg)
          if (rawTargetNum >= 1000 && w.nomKg && w.nomKg !== "-" && (parseNumber(w.nomKg) * 1000) === rawTargetNum && (w.nomKg.includes('*') === targetMark)) isStringMatch = true;
        } else if (isTargetKg) {
          const targetKgVal = rawTargetNum / 1000;
          if (w.nomKg && w.nomKg !== "-" && parseNumber(w.nomKg) === targetKgVal && (w.nomKg.includes('*') === targetMark)) isStringMatch = true;
        } else if (isTargetMg) {
          const targetMgVal = rawTargetNum * 1000;
          if (w.nomMg && w.nomMg !== "-" && parseNumber(w.nomMg) === targetMgVal && (w.nomMg.includes('*') === targetMark)) isStringMatch = true;
        }

        if (isNumericMatch || isStringMatch) {
          console.log(`      ‚úÖ [U1 MATCH] ${w.parentIdentitas} | ${w.nominal || ''}${w.unit || ''} | totalGram=${totalGram} | U=${w.uG || w.uKg || w.uMg || w.u}`);
        }
        return isNumericMatch || isStringMatch;
      });

      if (matches.length > 0) {
        matches.sort((a, b) => new Date(b.date) - new Date(a.date));
        const first = matches[0];
        const wlEntry = whitelistRaw.find(w => (w.noIdentitas || "").trim().toUpperCase() === first.parentIdentitas);
        const resolvedClass = (wlEntry && wlEntry.kelas) ? wlEntry.kelas : first.kelas;

        const units = [g_currentUnit, 'g', 'kg', 'mg'];
        const uniqueUnits = [...new Set(units)];

        let uVal = null;
        for (const u of uniqueUnits) {
          const key = u === 'g' ? 'uG' : (u === 'kg' ? 'uKg' : 'uMg');
          if (first[key] && first[key] !== "-") {
            const mult = u === 'kg' ? 1000 : (u === 'mg' ? 0.001 : 1);
            const rawVal = parseFloat(first[key].toString().replace(/\./g, "").replace(",", "."));
            uVal = rawVal * mult;
            break;
          }
        }
        if (uVal === null && first.u && first.u !== "-") {
          uVal = parseFloat(first.u.toString().replace(/\./g, "").replace(",", "."));
        }

        let mcVal = null;
        for (const u of uniqueUnits) {
          const key = u === 'g' ? 'mcG' : (u === 'kg' ? 'mcKg' : 'mcMg');
          if (first[key] && first[key] !== "-") {
            const mult = u === 'kg' ? 1000 : (u === 'mg' ? 0.001 : 1);
            const rawVal = parseFloat(first[key].toString().replace(/\./g, "").replace(",", "."));
            mcVal = rawVal * mult;
            break;
          }
        }
        if (mcVal === null && first.mc && first.mc !== "-") {
          mcVal = parseFloat(first.mc.toString().replace(/\./g, "").replace(",", "."));
        }

        return { u: uVal, mc: mcVal, kelas: resolvedClass || "" };
      }

      // 2. Composite Logic
      if (Math.abs(rawTargetNum - 1500) < 0.001) {
        const r1000 = findMasterUncertainty("1000", depth + 1);
        const r500 = findMasterUncertainty("500", depth + 1);
        if (r1000.u !== null && r500.u !== null) {
          return { u: r1000.u + r500.u, mc: (r1000.mc || 1000) + (r500.mc || 500), kelas: r1000.kelas };
        }
      } else if (Math.abs(rawTargetNum - 2000) < 0.001) {
        const r1000 = findMasterUncertainty("1000", depth + 1);
        const r1000Star = findMasterUncertainty("1000*", depth + 1);
        if (r1000.u !== null && r1000Star.u !== null) {
          return { u: r1000.u + r1000Star.u, mc: (r1000.mc || 1000) + (r1000Star.mc || 1000), kelas: r1000.kelas };
        }
      } else if (Math.abs(rawTargetNum - 3000) < 0.001) {
        // PER USER REQUEST: Must be exactly 2kg + 1kg. No 1kg+1kg*+1kg fallback.
        const combos = [["2000", "1000"], ["2kg", "1kg"]];
        for (const names of combos) {
          const res = names.map(n => findMasterUncertainty(n, depth + 1));
          if (res.every(r => r.u !== null)) {
            return {
              u: res.reduce((s, r) => s + r.u, 0),
              mc: res.reduce((s, r, i) => s + (r.mc || parseNumber(names[i])), 0),
              kelas: res[0].kelas
            };
          }
        }
      }
    } catch (e) {
      console.error("‚ùå [U1] Error", e);
    }
    return { u: null, mc: null, kelas: "" };
  }

  // Attach listeners
  document.getElementById('cert-u95')?.addEventListener('input', () => { if (typeof calculateUncertainty === 'function') calculateUncertainty(); });
  document.getElementById('mpe-val')?.addEventListener('input', () => { if (typeof calculateUncertainty === 'function') calculateUncertainty(); });
  document.getElementById('std-max')?.addEventListener('input', () => { if (typeof calculateUncertainty === 'function') calculateUncertainty(); });

  // Initialize calculations on page load
  console.log('üöÄ [INIT] Page loaded, initializing calculations...');
  setTimeout(() => {
    console.log('‚è∞ [INIT] Triggering initial calculations...');
    if (typeof calculateUncertainty === 'function') {
      calculateUncertainty();
      console.log('‚úÖ [INIT] calculateUncertainty() called');
    }
    if (typeof calculateLOP === 'function') {
      calculateLOP();
      console.log('‚úÖ [INIT] calculateLOP() called');
    }
  }, 100);

  // --- PDF EXPORT FUNCTION ---
  async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4'); // Portrait, A4

    // --- CONTENT MARGINS ---
    const pageMargins = { top: 55, left: 14, right: 14, bottom: 20 };
    let finalY = 55; // Initial start Y below header space

    // --- I. IDENTITAS ALAT ---
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text("I. Identitas Alat", 14, finalY);

    const identitasData = [
      ["No. Sertifikat Kalibrasi", document.getElementById("cert-no")?.value || ""],
      ["Merk / Type / SN", "AND / EK-1200i / P1850111"],
      ["Kapasitas / Daya Baca / e", document.getElementById("specs-cell")?.innerText || ""],
      ["No Identitas", document.getElementById("no-identitas")?.value || ""],
      ["Lokasi", "R. Timbang / QC Obat (Gedung A)"],
      ["Tanggal Kalibrasi", document.getElementById("cal-date")?.value || ""],
      ["Interval Kalibrasi", "12 Bulan"],
      ["Suhu / RH / Pa", `${document.getElementById("env-suhu")?.value || ""} ¬∞C / ${document.getElementById("env-rh")?.value || ""} % / ${document.getElementById("env-pa")?.value || ""} hPa`]
    ];

    doc.autoTable({
      startY: finalY + 2,
      body: identitasData,
      theme: 'grid',
      styles: { fontSize: 9, cellPadding: 1.5, lineColor: [0, 0, 0] },
      columnStyles: {
        0: { fontStyle: 'bold', cellWidth: 60, fillColor: [240, 240, 240] },
        1: { cellWidth: 'auto' }
      },
      didParseCell: function (data) {
        if (data.column.index === 0) {
          // Add colon or keep it clean? HTML has separate column.
          // Let's keep it clean since it's a grid now, or maybe append ":" for consistency if desired.
          // User said "hilangkan No Formulir...", didn't say remove colons.
          // But strict table usually separates label/value. Let's keep distinct columns without ":" inside the text to look cleaner, 
          // OR match the previous logic of adding it. 
          // Previous logic: data.cell.text = data.cell.text + " :";
          // If I use a grid, the border separates them. The HTML has a dedicated ":" column.
          // I'll stick to simple Label | Value grid. I will REMOVE the colon appending to make it look like a standard table.
        }
      },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY + 5;

    // --- II. IDENTITAS KALIBRATOR / BATU TIMBANG ---
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text("II. Identitas Kalibrator / Batu Timbang", 14, finalY);

    const supportData = [];
    for (let i = 1; i <= 3; i++) {
      const id = document.getElementById(`support-id-${i}`)?.value || "";
      const cert = document.getElementById(`support-cert-${i}`)?.value || "";
      const cls = document.getElementById(`support-class-${i}`)?.value || "";
      const last = document.getElementById(`support-last-${i}`)?.value || "";
      const next = document.getElementById(`support-next-${i}`)?.value || "";
      if (id || cert || cls) {
        supportData.push([i, id, cert, cls, last, next]);
      }
    }
    // Add dummy row if empty
    if (supportData.length === 0) supportData.push(["-", "-", "-", "-", "-", "-"]);

    doc.autoTable({
      startY: finalY + 2,
      head: [['No.', 'No. Identitas', 'No. Sertifikat', 'Kelas', 'Kalibrasi Terakhir', 'Kalibrasi Ulang']],
      body: supportData,
      theme: 'grid',
      styles: { fontSize: 8, halign: 'center' },
      headStyles: { fillColor: [220, 220, 220], textColor: 0 },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY + 5;

    // --- III. PENGUJIAN PRE-ADJUSTMENT ---
    doc.setFontSize(11);
    doc.text("III. Pengujian Pre-Adjustment", 14, finalY);

    const preNom = document.getElementById("pre-adj-nominal")?.innerText || "-";
    const preRi = document.querySelector(".pre-adj-abs-correction")?.value || "-";
    const postRi = document.querySelector(".post-adj-abs-correction")?.value || "-";

    // Dynamic Tolerance calculation for Pre-Adjustment
    const eVal = getVerificationScaleInterval();
    const accClass = getAccuracyClass();
    const nomVal = parseNumber(preNom);
    const m = nomVal / eVal;
    const mpeFactor = getMPEFactor(m, accClass);
    const preTolVal = mpeFactor * eVal;

    // Format with appropriate decimals
    let tolDec = g_decimals + 1;
    if (eVal.toString().includes('.')) {
      const eDec = eVal.toString().split('.')[1].length;
      if (eDec > tolDec) tolDec = eDec;
    }
    const preTol = formatNumber(preTolVal, tolDec);

    const kesimpulanPre = Math.abs(parseNumber(postRi)) <= preTolVal ? "MS" : "TMS";

    doc.autoTable({
      startY: finalY + 2,
      head: [
        [
          { content: 'Nominal Batu Timbang', rowSpan: 2, styles: { halign: 'center', valign: 'middle' } },
          { content: 'Koreksi', colSpan: 2, styles: { halign: 'center' } },
          { content: 'Toleransi (¬±)', rowSpan: 2, styles: { halign: 'center', valign: 'middle' } },
          { content: 'Kesimpulan', rowSpan: 3, styles: { halign: 'center', valign: 'middle' } }
        ],
        [
          { content: 'Pre-Adjustment', styles: { halign: 'center', fontStyle: 'bolditalic' } },
          { content: 'Post-Adjustment', styles: { halign: 'center', fontStyle: 'bolditalic' } }
        ],
        [
          { content: g_currentUnit, styles: { halign: 'center' } },
          { content: g_currentUnit, styles: { halign: 'center' } },
          { content: g_currentUnit, styles: { halign: 'center' } },
          { content: g_currentUnit, styles: { halign: 'center' } }
        ]
      ],
      body: [[preNom, preRi, postRi, preTol, kesimpulanPre]],
      theme: 'grid',
      styles: { fontSize: 9, halign: 'center', cellPadding: 2, lineWidth: 0.1, lineColor: [0, 0, 0] },
      headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold' },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY;

    // Pre-Adjustment Footer
    doc.autoTable({
      startY: finalY,
      body: [
        [
          { content: "Kriteria Penerimaan: Koreksi_Post-Adjustment <= Toleransi", styles: { halign: 'left' } },
          { content: "Toleransi: Sesuai Tabel MPE OIML R76-1", styles: { halign: 'right', fontStyle: 'bold' } }
        ]
      ],
      theme: 'grid',
      styles: { fontSize: 8, fontStyle: 'bold', cellPadding: 1, lineColor: [0, 0, 0], lineWidth: 0.1 },
      columnStyles: { 0: { cellWidth: 120 }, 1: { cellWidth: 62 } }, // Favor left column for long text
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY + 5;

    // --- IV. PENGUJIAN REPEATABILITY ---
    // Check space
    if (finalY > 230) { doc.addPage(); finalY = 55; }

    doc.setFontSize(11);
    doc.text("IV. Pengujian Repeatability", 14, finalY);

    const sd50 = document.getElementById("sd-50")?.value || "0";
    const sd100 = document.getElementById("sd-100")?.value || "0";
    const stdMax = document.getElementById("std-max")?.value || "0";
    const dVal = getResolutionFromSpecs();
    const repTolVal = 5 * dVal;
    const repTol = formatNumber(repTolVal);
    const kesimpulanRep = parseNumber(stdMax) <= repTolVal ? "MS" : "TMS";

    doc.autoTable({
      startY: finalY + 2,
      head: [[`Nominal (${g_currentUnit})`, `Std. Deviasi (${g_currentUnit})`, `Std. Dev Max (${g_currentUnit})`, `Toleransi (${g_currentUnit})`, 'Kesimpulan']],
      body: [
        [document.getElementById("nominal-50")?.value || "600", sd50, stdMax, repTol, kesimpulanRep],
        [document.getElementById("nominal-100")?.value || "1200", sd100, stdMax, repTol, kesimpulanRep]
      ],
      theme: 'grid',
      styles: { fontSize: 9, halign: 'center' },
      headStyles: { fillColor: [220, 220, 220], textColor: 0 },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY;

    // Repeatability Footer
    doc.autoTable({
      startY: finalY,
      body: [
        [
          { content: `Kriteria : Berdasarkan OIML R-76, Batas Toleransi = 5 x d (${repTol} ${g_currentUnit})`, styles: { halign: 'left', fontStyle: 'bolditalic' } }
        ]
      ],
      theme: 'grid',
      styles: { fontSize: 8, cellPadding: 1, lineColor: [0, 0, 0], lineWidth: 0.1 },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY + 5;

    // --- V. PENGUJIAN LINEARITY ---
    doc.addPage();
    finalY = 55;

    doc.setFontSize(11);
    doc.text("V. Pengujian Linearity", 14, finalY);

    // Get Linearity Data
    const linData = [];
    const lt = document.getElementById("linearity-table");
    if (lt) {
      // Pre-calculate values outside loop
      const eVal_lin = getVerificationScaleInterval();
      const accClass_lin = getAccuracyClass();
      const settings_lin = JSON.parse(localStorage.getItem('calibrationSettings') || '{}');
      const savedLin = settings_lin.linearityTolerances || [];

      const lRows = Array.from(lt.querySelectorAll("tbody tr")).filter(tr => tr.cells.length > 0 && tr.cells[0].hasAttribute("rowspan") && tr.cells[0].innerText.trim() !== "No");
      lRows.forEach((r, idx) => {
        const nomCell = r.cells[1];
        const nomSpan = nomCell?.querySelector('span');
        const nom = nomSpan ? nomSpan.innerText : (nomCell?.innerText || "-");

        const corrInput = r.cells[9].querySelector("input");
        const corr = corrInput?.dataset.fullValue || corrInput?.value || "0";

        // U95 from uncertainty table
        let u95 = "";
        const ut = document.getElementById("uncertainty-table");
        if (ut) {
          const utRows = ut.querySelectorAll("tbody tr");
          if (utRows[idx] && utRows[idx].cells.length > 12) {
            const rawU95 = utRows[idx].cells[12].innerText;
            u95 = formatNumber(parseNumber(rawU95), 5);
          }
        }

        // Tolerance logic using standard MPE helpers
        const matchedTol = savedLin.find(t => parseNumber(t.nominal) === parseNumber(nom));

        let tolVal;
        if (matchedTol) {
          tolVal = parseNumber(matchedTol.tolerance);
        } else {
          const nominalNum = parseNumber(nom);
          const loadM = nominalNum / eVal_lin;
          const mpeFactor = getMPEFactor(loadM, accClass_lin);
          tolVal = mpeFactor * eVal_lin;
        }

        const linTolDisplay = formatNumber(tolVal, g_decimals + 1);
        const kesimpulanLin = Math.abs(parseNumber(corr)) <= tolVal ? "MS" : "TMS";

        linData.push([nom, corr, linTolDisplay, kesimpulanLin, u95]);
      });
    }

    doc.autoTable({
      startY: finalY + 2,
      head: [[`Nominal (${g_currentUnit})`, `Koreksi (${g_currentUnit})`, `Toleransi (${g_currentUnit})`, 'Kesimpulan', `U95 (${g_currentUnit})`]],
      body: linData,
      theme: 'grid',
      styles: { fontSize: 9, halign: 'center' },
      headStyles: { fillColor: [220, 220, 220], textColor: 0 },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY;

    // Linearity Footer
    doc.autoTable({
      startY: finalY,
      body: [
        [
          { content: "Kriteria Penerimaan : Koreksi (C) <= Toleransi", styles: { halign: 'left' } },
          { content: "Toleransi : Sesuai Tabel MPE OIML R76-1", styles: { halign: 'right', fontStyle: 'bolditalic' } }
        ]
      ],
      theme: 'grid',
      styles: { fontSize: 8, fontStyle: 'bold', cellPadding: 1, lineColor: [0, 0, 0], lineWidth: 0.1 },
      columnStyles: { 0: { cellWidth: 91 }, 1: { cellWidth: 91 } },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY + 5;

    // --- VI. PENGUJIAN ECCENTRICITY ---
    if (finalY > 230) { doc.addPage(); finalY = 55; }
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text("VI. Pengujian Eccentricity", 14, finalY);

    const et = document.getElementById("eccentricity-table");
    let eccBody = [];
    const posNames = ["Tengah (1)", "Depan (2)", "Kiri (3)", "Belakang (4)", "Kanan (5)"];

    const settings_ecc = JSON.parse(localStorage.getItem('calibrationSettings') || '{}');
    const eccTolStr = settings_ecc.eccTolerance ? settings_ecc.eccTolerance.replace('%', '') : "0,05";

    if (et) {
      const eRows = et.querySelectorAll("tbody tr");
      if (eRows.length > 0) {
        const nomEcc = eRows[0].cells[4].querySelector("input")?.value || "-";
        const sdEcc = eRows[0].cells[2].querySelector("input")?.value || "-";
        const rsdEcc = eRows[0].cells[3].querySelector("input")?.value || "-";
        const kesimpulanEcc = parseNumber(rsdEcc) <= parseNumber(eccTolStr) ? "MS" : "TMS";

        // Row 1: Includes all rowspanned columns
        const r0 = eRows[0].querySelector("input:not([readonly])")?.value || "";
        eccBody.push([
          { content: nomEcc, rowSpan: 5, styles: { valign: 'middle', halign: 'center' } },
          posNames[0],
          r0,
          { content: sdEcc, rowSpan: 5, styles: { valign: 'middle', halign: 'center' } },
          { content: rsdEcc, rowSpan: 5, styles: { valign: 'middle', halign: 'center' } },
          { content: eccTolStr, rowSpan: 5, styles: { valign: 'middle', halign: 'center' } },
          { content: kesimpulanEcc, rowSpan: 5, styles: { valign: 'middle', halign: 'center' } }
        ]);

        // Rows 2-5: Only Position and Reading
        for (let i = 1; i < 5; i++) {
          const r = eRows[i].querySelector("input:not([readonly])")?.value || "";
          eccBody.push([posNames[i], r]);
        }
      }
    }

    doc.autoTable({
      startY: finalY + 2,
      head: [
        [`Nominal Batu Timbang`, 'Posisi Penimbangan', `Pembacaan (R) (${g_currentUnit})`, `Standar Deviasi (S) (${g_currentUnit})`, '%RSD (%)', 'Toleransi (¬±) (%)', 'Kesimpulan']
      ],
      body: eccBody,
      theme: 'grid',
      styles: { fontSize: 9, halign: 'center', cellPadding: 2, lineWidth: 0.1, lineColor: [0, 0, 0] },
      headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold', valign: 'middle' },
      columnStyles: {
        0: { cellWidth: 30 }, // Nominal
        1: { cellWidth: 30, halign: 'left' }, // Posisi
        6: { fontStyle: 'bold' } // Kesimpulan
      },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY + 2;
    // Eccentricity Footer using autoTable for alignment
    doc.autoTable({
      startY: finalY,
      body: [
        [
          { content: "Kriteria Penerimaan : %RSD <= Toleransi ", styles: { halign: 'left' } },
          { content: `Toleransi : %RSD <= ${eccTolStr}%`, styles: { halign: 'right', fontStyle: 'bolditalic' } }
        ]
      ],
      theme: 'grid',
      styles: { fontSize: 8, fontStyle: 'bold', cellPadding: 1, lineColor: [0, 0, 0], lineWidth: 0.1 },
      columnStyles: { 0: { cellWidth: 91 }, 1: { cellWidth: 91 } },
      margin: pageMargins
    });
    finalY = doc.lastAutoTable.finalY + 5;

    // --- VII. PENGUJIAN HYSTERISIS ---
    if (finalY > 230) { doc.addPage(); finalY = 55; }
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.text("VII. Pengujian Hysterisis", 14, finalY);

    const hTable = document.getElementById("hysterisis-table");
    let hBody = [];
    let hysterisisResult = "-";

    if (hTable) {
      const hRows = hTable.querySelectorAll("tbody tr");
      if (hRows.length > 0) {
        const nominalHys = hRows[0].cells[0].querySelector("input")?.value || "-";

        const pLabels = ["p1", "p2", "p3", "p4"];
        const qLabels = ["q1", "q2", "q3", "q4"];
        let pVals = [], qVals = [];

        pVals.push(hRows[0].cells[2].querySelector("input")?.value || "");
        qVals.push(hRows[0].cells[4].querySelector("input")?.value || "");

        for (let i = 1; i <= 3; i++) {
          pVals.push(hRows[i].cells[1].querySelector("input")?.value || "");
          qVals.push(hRows[i].cells[3].querySelector("input")?.value || "");
        }

        hysterisisResult = hRows[4].querySelector("input")?.value || "0,000";

        // Construct 4 rows
        hBody.push([
          { content: nominalHys, rowSpan: 4, styles: { valign: 'middle', halign: 'center' } },
          pLabels[0], pVals[0], qLabels[0], qVals[0]
        ]);

        for (let i = 1; i < 4; i++) {
          hBody.push([pLabels[i], pVals[i], qLabels[i], qVals[i]]);
        }

        // Result Row
        hBody.push([
          { content: "Hysterisis", styles: { halign: 'center', fontStyle: 'bolditalic', fillColor: [230, 230, 230] } },
          { content: hysterisisResult, colSpan: 4, styles: { halign: 'center', fontStyle: 'bold', fillColor: [230, 230, 230] } }
        ]);
      }
    }

    doc.autoTable({
      startY: finalY + 2,
      head: [
        [
          { content: `Nominal Batu Timbang\n${g_currentUnit}`, styles: { valign: 'middle', halign: 'center' } },
          { content: `Nilai p\n${g_currentUnit}`, colSpan: 2, styles: { halign: 'center', fontStyle: 'bold' } },
          { content: `Nilai q\n${g_currentUnit}`, colSpan: 2, styles: { halign: 'center', fontStyle: 'bold' } }
        ]
      ],
      body: hBody,
      theme: 'grid',
      styles: { fontSize: 9, halign: 'center', cellPadding: 2, lineWidth: 0.1, lineColor: [0, 0, 0] },
      headStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold', lineWidth: 0.1, lineColor: [0, 0, 0] },
      columnStyles: {
        0: { cellWidth: 40 },
        1: { cellWidth: 20 },
        2: { cellWidth: 51 },
        3: { cellWidth: 20 },
        4: { cellWidth: 51 }
      },
      margin: pageMargins
    });

    finalY = doc.lastAutoTable.finalY; // No padding, footer attaches

    // Hysterisis Footer
    doc.autoTable({
      startY: finalY,
      body: [
        [
          { content: "Kriteria Penerimaan : Hysterisis <= Toleransi", styles: { halign: 'left' } },
          { content: "Toleransi : Sesuai Tabel MPE OIML R76-1", styles: { halign: 'right' } }
        ],
        [
          { content: "**Pengukuran Hysterisis dilakukan pada saat timbangan pertama kali dikalibrasi atau sesudah perbaikan.", colSpan: 2, styles: { halign: 'left', fontStyle: 'normal' } }
        ]
      ],
      theme: 'grid',
      styles: { fontSize: 8, fontStyle: 'bold', cellPadding: 1, lineColor: [0, 0, 0], lineWidth: 0.1 },
      columnStyles: { 0: { cellWidth: 91 }, 1: { cellWidth: 91 } }, // Split evenly (Total 182)
      margin: pageMargins
    });
    finalY = doc.lastAutoTable.finalY + 10;

    // --- VIII. LOP ---
    if (finalY > 250) { doc.addPage(); finalY = 55; }

    // LOP Table
    const lopVal = document.getElementById('lop-display')?.innerText.replace("F = ", "") || "-";

    doc.autoTable({
      startY: finalY,
      head: [
        [{ content: "VIII. LOP/Limit of Performance (F)", colSpan: 3, styles: { halign: 'left', fontStyle: 'bold' } }]
      ],
      body: [
        [
          { content: "", styles: { cellWidth: 50 } }, // Spacer
          { content: "¬±", styles: { cellWidth: 10, halign: 'center' } },
          { content: lopVal, styles: { fillColor: [146, 208, 80], fontStyle: 'bold', halign: 'center' } } // Green
        ]
      ],
      theme: 'grid',
      styles: { fontSize: 10, lineColor: [0, 0, 0], lineWidth: 0.1 },
      headStyles: { fillColor: [255, 255, 255], textColor: 0, lineWidth: 0 }, // White header
      margin: pageMargins
    });
    finalY = doc.lastAutoTable.finalY + 5;

    // --- IX - XII Details Table ---
    if (finalY > 250) { doc.addPage(); finalY = 55; }

    const acuanVal = document.getElementById('acuan-val')?.innerText || "-";
    const kesimpulanVal = document.getElementById('kesimpulan-val')?.value || "-";

    const nextCalDate = document.getElementById('next-cal-date')?.value;
    let formattedNextCal = nextCalDate;
    if (nextCalDate) {
      const d = new Date(nextCalDate);
      const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
      formattedNextCal = `${d.getDate().toString().padStart(2, '0')} ${months[d.getMonth()]} ${d.getFullYear()}`;
    } else {
      formattedNextCal = "-";
    }

    const ketVal = document.getElementById('keterangan-val')?.value || "NA";

    const detailsBody = [
      [
        { content: "IX. Acuan :", styles: { fontStyle: 'bold' } },
        { content: acuanVal, styles: { fontStyle: 'bold' } }
      ],
      [
        { content: "X. Kesimpulan :", styles: { fontStyle: 'bold' } },
        { content: kesimpulanVal, styles: { fillColor: [250, 191, 143], fontStyle: 'bold' } } // Orange
      ],
      [
        { content: "XI. Kalibrasi ulang :", styles: { fontStyle: 'bold' } },
        { content: formattedNextCal, styles: { fillColor: [146, 208, 80], fontStyle: 'bold' } } // Green
      ],
      [
        { content: "XII. Keterangan :", styles: { fontStyle: 'bold' } },
        { content: ketVal, styles: { fontStyle: 'bold' } }
      ]
    ];

    doc.autoTable({
      startY: finalY,
      body: detailsBody,
      theme: 'grid',
      styles: { fontSize: 10, cellPadding: 1.5, lineColor: [0, 0, 0], lineWidth: 0.1, valign: 'middle' },
      columnStyles: {
        0: { cellWidth: 40 },
        1: { cellWidth: 'auto' }
      },
      margin: pageMargins
    });
    finalY = doc.lastAutoTable.finalY + 15;

    // --- SIGNATURE SECTION (Fixed at bottom) ---
    const pageHeight = doc.internal.pageSize.getHeight();
    const sigBaseY = pageHeight - 65; // Moved up slightly

    // If content reached signature area, add page
    if (finalY > sigBaseY - 10) {
      doc.addPage();
    }

    const sigRoleY = sigBaseY + 25; // More room for signature
    doc.setFontSize(9); // Slightly smaller to give more space
    doc.setFont("helvetica", "normal");

    // Headers
    doc.text("Dikerjakan oleh,", 30, sigBaseY, { align: "center" });
    doc.text("Diperiksa Oleh,", 92.5, sigBaseY, { align: "center" });
    doc.text("Disetujui oleh,", 165, sigBaseY, { align: "center" });

    // Roles (lines)
    doc.text("(Teknisi Kalibrasi)", 30, sigRoleY, { align: "center" });
    doc.line(15, sigRoleY + 1, 45, sigRoleY + 1);

    doc.text("(KKV Supervisor)", 75, sigRoleY, { align: "center" });
    doc.line(60, sigRoleY + 1, 90, sigRoleY + 1);
    doc.text("(QS Asst. Manager)", 110, sigRoleY, { align: "center" });
    doc.line(95, sigRoleY + 1, 125, sigRoleY + 1);

    doc.text("(Maint & Eng Manager)", 145, sigRoleY, { align: "center" });
    doc.line(130, sigRoleY + 1, 160, sigRoleY + 1);
    doc.text("(QA Manager)", 185, sigRoleY, { align: "center" });
    doc.line(170, sigRoleY + 1, 200, sigRoleY + 1);

    // Dates (Increased space and left-aligned for handwriting)
    const dateY = sigRoleY + 12;
    doc.text("Tanggal : ..........................", 15, dateY);
    doc.text("Tanggal : ..........................", 60, dateY);
    doc.text("Tanggal : ..........................", 95, dateY);
    doc.text("Tanggal : ..........................", 130, dateY);
    doc.text("Tanggal : ..........................", 170, dateY);

    // --- DRAW HEADERS ON ALL PAGES ---
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
      doc.setPage(i);

      doc.autoTable({
        startY: 15,
        body: [
          [
            { content: "PT. L'ESSENTIAL", rowSpan: 4, styles: { halign: 'center', valign: 'middle', fontStyle: 'bold' } },
            { content: "LAPORAN KALIBRASI TIMBANGAN ELEKTRONIK\n(PRESISI/TEKNIKAL)", rowSpan: 4, styles: { halign: 'center', valign: 'middle', fontStyle: 'bold', fontSize: 12 } },
            { content: `Halaman : ${i} dari ${totalPages}`, styles: { halign: 'left' } }
          ],
          ["No. Formulir : " + (document.getElementById("form-no")?.value || "")],
          ["Revisi : " + (document.getElementById("rev-no")?.value || "")],
          ["Tanggal Berlaku : " + (document.getElementById("eff-date")?.value || "")]
        ],
        theme: 'grid',
        styles: {
          fontSize: 10,
          lineColor: [0, 0, 0],
          lineWidth: 0.1,
          cellPadding: 2
        },
        columnStyles: {
          0: { cellWidth: 40 },
          1: { cellWidth: 'auto' },
          2: { cellWidth: 50, fontSize: 9 }
        },
        margin: { left: 14, right: 14 }
      });
    }

    // Generate filename
    const certNoFilename = document.getElementById("cert-no")?.value || "Laporan";
    const cleanFilename = certNoFilename.replace(/[^a-zA-Z0-9-_]/g, "_");
    doc.save(`${cleanFilename}.pdf`);
  }
  // No secondary calculateLOP here

  let g_regressionChart = null;

  function formatIndonesianExcel(num, decimals) {
    if (num === null || num === undefined || isNaN(num)) return "-";
    // Base formatting using Indonesian locale
    let str = new Intl.NumberFormat('id-ID', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    }).format(num);

    // Specific "cool" decimal grouping as requested for internal chart display
    // e.g., 0,999,906,577 (Excel style grouping in decimal part)
    let parts = str.split(',');
    let dec = parts[1] || "";
    if (dec && dec.length > 3) {
      let groupedDec = "";
      for (let i = 0; i < dec.length; i++) {
        if (i > 0 && i % 3 === 0) groupedDec += ",";
        groupedDec += dec[i];
      }
      str = parts[0] + "," + groupedDec;
    }
    return str;
  }

  function updateChart(xVals, yVals, slope, intercept, rSquare) {
    const ctx = document.getElementById('regressionChart');
    if (!ctx) return;

    // Filter valid data
    const points = xVals.map((x, i) => ({ x: x, y: yVals[i] }));

    // Determine max X for trendline (add some padding or just use max)
    const maxX = xVals.length > 0 ? Math.max(...xVals) : 1400;

    // Sort for trendline
    const lineX = [0, maxX];
    const lineY = lineX.map(x => intercept + slope * x);

    const equationText = `y = ${formatIndonesianExcel(slope, 9)}x + ${formatIndonesianExcel(intercept, 9)}`;
    const r2Text = `R¬≤ = ${formatIndonesianExcel(rSquare, 9)}`;

    const chartData = {
      datasets: [
        {
          label: 'Regresi Linear',
          data: points,
          backgroundColor: 'rgba(54, 162, 235, 1)',
          borderColor: 'rgba(54, 162, 235, 1)',
          pointStyle: 'rectRot',
          pointRadius: 6,
          showLine: true,
          borderWidth: 1,
          type: 'scatter',
          order: 2
        },
        {
          label: 'Linear (Regresi Linear)',
          data: [
            { x: lineX[0], y: lineY[0] },
            { x: lineX[1], y: lineY[1] }
          ],
          borderColor: 'rgba(0, 0, 0, 1)',
          borderWidth: 1.5,
          pointRadius: 0,
          fill: false,
          type: 'line',
          order: 1
        }
      ]
    };

    // Determine decimal places for ticks
    // Use g_decimals if available (global var from other parts of the script), 
    // or fallback to 3.
    const tickDecimals = (typeof g_decimals !== 'undefined') ? g_decimals : 3;

    const tickCallback = function (value) {
      // Format number with Indonesian comma separator
      // and dynamic decimals
      return new Intl.NumberFormat('id-ID', {
        minimumFractionDigits: tickDecimals,
        maximumFractionDigits: tickDecimals
      }).format(value);
    };

    if (g_regressionChart) {
      g_regressionChart.data = chartData;
      g_regressionChart.options.plugins.customData = { equation: equationText, r2: r2Text };

      // Update scales options dynamically
      g_regressionChart.options.scales.x.ticks.callback = tickCallback;
      g_regressionChart.options.scales.y.ticks.callback = tickCallback;

      // Reset min/max to allow auto-scaling (remove fixed limits if they existed)
      delete g_regressionChart.options.scales.x.min;
      delete g_regressionChart.options.scales.x.max;
      delete g_regressionChart.options.scales.y.min;
      delete g_regressionChart.options.scales.y.max;

      g_regressionChart.update();
    } else {
      g_regressionChart = new Chart(ctx, {
        type: 'scatter',
        data: chartData,
        plugins: [{
          id: 'customDataOverlay',
          afterDraw: (chart) => {
            const { ctx, chartArea: { top, right, bottom, left, width, height } } = chart;
            const data = chart.options.plugins.customData;
            if (!data || !data.equation) return;

            ctx.save();
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#000';
            // Positioned inside the chart like in the Excel image
            ctx.fillText(data.equation, left + width * 0.65, top + height * 0.55);
            ctx.fillText(data.r2, left + width * 0.65, top + height * 0.55 + 20);
            ctx.restore();
          }
        }],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: {
              left: 40,
              right: 20,
              top: 10,
              bottom: 10
            }
          },
          plugins: {
            customData: { equation: equationText, r2: r2Text },
            title: {
              display: true,
              text: 'Regresi Linear',
              font: { size: 22, weight: 'bold' },
              color: '#000',
              padding: { bottom: 20 }
            },
            legend: {
              position: 'right',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: { size: 12 }
              }
            },
            tooltip: { enabled: true }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Bobot Aktual',
                font: { weight: 'bold', size: 13 }
              },
              grid: { display: false },
              ticks: {
                // Auto-step size
                callback: tickCallback
              }
            },
            y: {
              title: {
                display: true,
                text: 'Massa Konvensional',
                font: { weight: 'bold', size: 13 }
              },
              grid: { color: '#bbb', lineWidth: 1 },
              ticks: {
                // Auto-step size
                callback: tickCallback
              }
            }
          }
        }
      });
    }
  }

  function toleransiKalibrasi() {
    const d = getResolutionFromSpecs();
    localStorage.setItem('calibrationReadability', d);
    window.location.href = "toleransiKalibrasi.html";
  }
</script>
<!-- MODAL MASTER DATA LOOKUP -->
<div id="modal-master-lookup"
  class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center p-4 no-print text-[14px]">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden text-black">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-indigo-600 text-white">
      <h3 class="font-bold text-lg">Pilih Batu Timbang dari Master</h3>
      <button onclick="closeMasterLookup()" class="text-white opacity-70 hover:opacity-100">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </svg>
      </button>
    </div>
    <div class="p-4 overflow-y-auto flex-1 text-black custom-scrollbar">
      <div class="mb-4 text-left flex justify-between items-end gap-4">
        <div class="flex-1">
          <label class="block text-sm font-semibold text-gray-700 mb-1 text-left">Pilih Set Batu Timbang</label>
          <select id="lookup-id-select"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500 text-black"
            onchange="renderLookupWeights()">
            <option value="">Pilih ID Batu Timbang...</option>
          </select>
        </div>
        <div id="lookup-bulk-actions" class="hidden">
          <div class="flex gap-2">
            <button onclick="toggleAllWeights(true)"
              class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg text-xs font-bold hover:bg-indigo-200 transition-all">Pilih
              Semua</button>
            <button onclick="toggleAllWeights(false)"
              class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-xs font-bold hover:bg-gray-200 transition-all">Hapus
              Semua</button>
          </div>
        </div>
      </div>
      <div id="lookup-weights-container" class="border border-gray-300 rounded-xl overflow-hidden">
        <p class="text-center text-gray-400 py-8">Pilih ID Batu Timbang terlebih dahulu</p>
      </div>
    </div>
    <div id="lookup-footer" class="p-4 border-t border-gray-100 hidden bg-gray-50">
      <button id="lookup-confirm-btn"
        class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
        Konfirmasi Pilihan
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 6 9 17l-5-5" />
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- MODAL MPE TABLE VIEW -->
<div id="modal-mpe-view"
  class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center p-4 no-print">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col overflow-hidden text-black">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-amber-600 text-white">
      <h3 class="font-bold text-lg">Tabel MPE (Maximum Permissible Error) - OIML R-111</h3>
      <button onclick="closeMPEModal()" class="text-white opacity-70 hover:opacity-100">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </svg>
      </button>
    </div>
    <div class="p-6 overflow-auto flex-1 text-black custom-scrollbar">
      <table class="w-full border-collapse border border-gray-300 text-[11px]">
        <thead>
          <tr class="bg-gray-100 text-center font-bold">
            <th class="border border-gray-300 p-2">Nominal Value</th>
            <th class="border border-gray-300 p-2">Class E1</th>
            <th class="border border-gray-300 p-2">Class E2</th>
            <th class="border border-gray-300 p-2">Class F1</th>
            <th class="border border-gray-300 p-2">Class F2</th>
            <th class="border border-gray-300 p-2">Class M1</th>
            <th class="border border-gray-300 p-2">Class M1-2</th>
            <th class="border border-gray-300 p-2">Class M2</th>
            <th class="border border-gray-300 p-2">Class M2-3</th>
            <th class="border border-gray-300 p-2">Class M3</th>
          </tr>
        </thead>
        <tbody id="mpe-modal-body" class="text-center">
          <!-- Populated by JS -->
        </tbody>
      </table>
      <p class="mt-4 text-[10px] text-gray-500 italic">* All MPE values are in milligrams (mg).</p>
    </div>
  </div>
</div>

<!-- MODAL MANUAL INPUT FOR LINEARITY -->
<div id="modal-manual-input"
  class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center p-4 no-print">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md flex flex-col overflow-hidden text-black">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-green-600 text-white">
      <h3 class="font-bold text-lg">Hitung Nominal Batu Timbang</h3>
      <button onclick="closeManualInputModal()" class="text-white opacity-70 hover:opacity-100">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </svg>
      </button>
    </div>
    <div class="p-6 text-black">
      <p class="text-sm text-gray-600 mb-4">Pilih dua Batu Timbang dari Master Data untuk menghitung Nominal gabungan
      </p>

      <div class="space-y-4">
        <!-- Batu Timbang 1 -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Batu Timbang 1</label>
          <button onclick="openMasterLookupForManual(1)"
            class="w-full px-4 py-3 bg-indigo-50 border-2 border-indigo-200 rounded-lg hover:bg-indigo-100 transition-all text-left flex items-center justify-between group">
            <div class="flex-1">
              <div id="manual-weight1-display" class="text-sm text-gray-500">Klik untuk pilih batu timbang...</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" class="text-indigo-600">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        </div>

        <!-- Batu Timbang 2 -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Batu Timbang 2</label>
          <button onclick="openMasterLookupForManual(2)"
            class="w-full px-4 py-3 bg-indigo-50 border-2 border-indigo-200 rounded-lg hover:bg-indigo-100 transition-all text-left flex items-center justify-between group">
            <div class="flex-1">
              <div id="manual-weight2-display" class="text-sm text-gray-500">Klik untuk pilih batu timbang...</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" class="text-indigo-600">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
        </div>

        <!-- Result Display -->
        <div class="space-y-3">
          <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Hasil Nominal Gabungan</label>
            <div id="manual-result-nominal" class="text-2xl font-bold text-green-600">-</div>
            <div id="manual-formula-nominal" class="text-xs text-gray-500 mt-1"></div>
          </div>

          <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
            <label class="block text-sm font-semibold text-gray-700 mb-1">Hasil Massa Konvensional Gabungan</label>
            <div id="manual-result-mc" class="text-2xl font-bold text-blue-600">-</div>
            <div id="manual-formula-mc" class="text-xs text-gray-500 mt-1"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="p-4 border-t border-gray-100 bg-gray-50 flex gap-2">
      <button onclick="closeManualInputModal()"
        class="flex-1 py-3 bg-gray-600 text-white rounded-xl font-bold shadow-lg hover:bg-gray-700 transition-all">
        Tutup
      </button>
      <button onclick="submitManualInput()" id="manual-submit-btn"
        class="flex-1 py-3 bg-green-600 text-white rounded-xl font-bold shadow-lg hover:bg-green-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
        disabled>
        Submit ke Tabel
      </button>
    </div>
  </div>
</div>

<script>
  function openMPEModal() {
    const modal = document.getElementById('modal-mpe-view');
    const tbody = document.getElementById('mpe-modal-body');

    // Sort all nominals from MPE_TABLE
    const allNominals = new Set();
    Object.values(MPE_TABLE).forEach(cls => {
      Object.keys(cls).forEach(nom => allNominals.add(Number(nom)));
    });
    const sortedNoms = Array.from(allNominals).sort((a, b) => b - a);

    tbody.innerHTML = sortedNoms.map(nom => {
      let nomDisplay = "";
      if (nom >= 1000) nomDisplay = (nom / 1000) + ' kg';
      else if (nom >= 1) nomDisplay = nom + ' g';
      else nomDisplay = Math.round(nom * 1000) + ' mg';

      const classes = ['E1', 'E2', 'F1', 'F2', 'M1', 'M1-2', 'M2', 'M2-3', 'M3'];

      return `
        <tr class="hover:bg-amber-50 transition-colors">
          <td class="border border-gray-300 p-1.5 font-bold bg-gray-50 text-indigo-700">${nomDisplay}</td>
          ${classes.map(cls => {
        const val = MPE_TABLE[cls] && MPE_TABLE[cls][nom] !== undefined ? MPE_TABLE[cls][nom] : '-';
        // Format with dot separator (id-ID uses dot for thousands)
        const formattedVal = (typeof val === 'number') ? val.toLocaleString('id-ID') : val;
        return `<td class="border border-gray-300 p-1.5 ${val === '-' ? 'bg-gray-50 text-gray-300' : 'font-medium'}">${formattedVal}</td>`;
      }).join('')}
        </tr>
      `;
    }).join('');

    modal.classList.remove('hidden');
  }

  function closeMPEModal() {
    document.getElementById('modal-mpe-view').classList.add('hidden');
  }

  let currentLookupTarget = null;
  let masterBatuData = [];

  // Centralized helper to get filtered Master Data based on Supporting Data (Section 1B)
  function getValidMasterData() {
    const allMaster = JSON.parse(localStorage.getItem('masterBatuTimbang') || '[]');
    const ids = [];
    for (let i = 1; i <= 3; i++) {
      const val = document.getElementById(`support-id-${i}`)?.value.trim();
      if (val) ids.push(val.toUpperCase());
    }

    // If no IDs are entered, return everything (fallback behavior)
    if (ids.length === 0) return allMaster;

    // Otherwise, return only matching sets (Standardize ID for comparison)
    return allMaster.filter(m => {
      const setId = (m.noIdentitas || m.id || "").trim().toUpperCase();
      return ids.includes(setId);
    });
  }

  function openMasterLookup(type, elementId = null) {
    if (type === 'support-row') {
      masterBatuData = JSON.parse(localStorage.getItem('masterBatuTimbang') || '[]');
    } else {
      masterBatuData = getValidMasterData(); // USE FILTERED DATA
    }
    const allMasterTotal = JSON.parse(localStorage.getItem('masterBatuTimbang') || '[]');

    if (allMasterTotal.length === 0) {
      alert('Data Master Batu Timbang belum ada. Silakan isi di menu Master Data.');
      return;
    }

    if (masterBatuData.length === 0) {
      alert('Tidak ada Data Master yang cocok dengan ID di "DATA BATU TIMBANG YANG DIGUNAKAN".\nSilakan isi tabel 1B terlebih dahulu.');
      return;
    }

    currentLookupTarget = { type, elementId };
    const select = document.getElementById('lookup-id-select');
    const currentValue = select.value;
    select.innerHTML = '<option value="">Pilih ID Batu Timbang...</option>' +
      masterBatuData.map(d => '<option value="' + d.id + '"' + (d.id === currentValue ? ' selected' : '') + '>' + d.id + ' (' + d.sertifikat + ')</option>').join('');

    document.getElementById('modal-master-lookup').classList.remove('hidden');
    renderLookupWeights();
  }

  function closeMasterLookup() {
    // Check if we're closing from manual input context
    const wasManualInput = currentLookupTarget && currentLookupTarget.type === 'manual-input';

    document.getElementById('modal-master-lookup').classList.add('hidden');

    // Restore manual input modal if it was hidden
    if (wasManualInput) {
      document.getElementById('modal-manual-input').classList.remove('hidden');
    }
  }

  function renderLookupWeights() {
    const id = document.getElementById('lookup-id-select').value;
    const container = document.getElementById('lookup-weights-container');
    const bulkActions = document.getElementById('lookup-bulk-actions');
    const footer = document.getElementById('lookup-footer');
    const confirmBtn = document.getElementById('lookup-confirm-btn');

    if (!id) {
      container.innerHTML = '<p class=\"text-center text-gray-400 py-20 bg-gray-50\">Pilih ID Batu Timbang terlebih dahulu</p>';
      if (bulkActions) bulkActions.classList.add('hidden');
      if (footer) footer.classList.add('hidden');
      return;
    }

    const set = masterBatuData.find(d => d.id === id);
    if (!set || !set.weights) return;

    if (currentLookupTarget.type === 'calibrator') {
      bulkActions.classList.remove('hidden');
      footer.classList.remove('hidden');
      confirmBtn.onclick = () => confirmCalibratorSelection(set.id);
    } else {
      bulkActions.classList.add('hidden');
      footer.classList.add('hidden');
    }

    // Special case for 'support-row': clicking any weight selects the SET
    const isSupportRow = currentLookupTarget.type === 'support-row';
    const isMulti = currentLookupTarget.type === 'calibrator';

    // Helper for table display (matching masterBatuTimbang.html)
    const getDisp = (w, field) => {
      // Prioritize new independent fields
      if (w[field] !== undefined && w[field] !== "" && w[field] !== "-") return w[field];

      // Fallback mapping for old data
      if (field === 'nomMg') return w.unit === 'mg' ? `${w.nominal}${w.mark ? '*' : ''}` : "-";
      if (field === 'nomG') return (w.unit === 'g' || (!w.unit && w.nominal)) ? `${w.nominal}${w.mark ? '*' : ''}` : "-";
      if (field === 'nomKg') return w.unit === 'kg' ? `${w.nominal}${w.mark ? '*' : ''}` : "-";

      const mcVal = w.mc ? w.mc.toString().replace('.', ',') : "-";
      if (field === 'mcMg') return w.unit === 'mg' ? mcVal : "-";
      if (field === 'mcG') return (w.unit === 'g' || (!w.unit && w.nominal)) ? mcVal : "-";
      if (field === 'mcKg') return w.unit === 'kg' ? mcVal : "-";

      const uVal = w.u ? w.u.toString().replace('.', ',') : "-";
      if (field === 'uMg') return w.unit === 'mg' ? uVal : "-";
      if (field === 'uG') return (w.unit === 'g' || (!w.unit && w.nominal)) ? uVal : "-";
      if (field === 'uKg') return w.unit === 'kg' ? uVal : "-";

      return "-";
    };

    container.innerHTML = `
      <div class="${isSupportRow ? 'bg-blue-50 p-2 text-center text-xs text-blue-700 mb-2 border border-blue-200 rounded' : 'hidden'}">
        Klik baris mana saja untuk memilih Set Batu Timbang ini
      </div>
      <table class="w-full border-collapse text-center text-[10px]">
        <thead>
          <tr class="bg-[#92d050] text-black shrink-0">
            <th rowspan="2" class="border border-gray-400 p-1 w-8">${isMulti ? '' : 'Pilih'}</th>
            <th colspan="3" class="border border-gray-400 p-1 bg-[#c5e0b4]">Nominal</th>
            <th colspan="3" class="border border-gray-400 p-1 bg-[#c5e0b4]">Massa Konvensional</th>
            <th colspan="3" class="border border-gray-400 p-1 bg-[#c5e0b4]">Ketidakpastian</th>
          </tr>
          <tr class="bg-[#e2efda] text-black font-bold">
            <th class="border border-gray-400 p-1 w-12">mg</th>
            <th class="border border-gray-400 p-1 w-12">g</th>
            <th class="border border-gray-400 p-1 w-12">Kg</th>
            <th class="border border-gray-400 p-1 w-20">mg</th>
            <th class="border border-gray-400 p-1 w-20">g</th>
            <th class="border border-gray-400 p-1 w-24">Kg</th>
            <th class="border border-gray-400 p-1 w-20">mg</th>
            <th class="border border-gray-400 p-1 w-20">g</th>
            <th class="border border-gray-400 p-1 w-24">Kg</th>
          </tr>
        </thead>
        <tbody>
          ${set.weights.map((w, idx) => `
            <tr onclick="${isMulti ? '' : `selectWeightFromMaster(${idx})`}" class="${isMulti ? '' : 'cursor-pointer hover:bg-amber-50'} transition-colors border-b border-gray-200">
              <td class="border border-gray-200 p-1.5">
                ${isMulti ? `<input type="checkbox" class="weight-checkbox w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500" value="${idx}" checked>` : `
                  <div class="text-indigo-600 font-bold text-[10px] flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                  </div>
                `}
              </td>
              <td class="border border-gray-200 px-1 py-1.5">${getDisp(w, 'nomMg')}</td>
              <td class="border border-gray-200 px-1 py-1.5 font-bold">${getDisp(w, 'nomG')}</td>
              <td class="border border-gray-200 px-1 py-1.5">${getDisp(w, 'nomKg')}</td>
              <td class="border border-gray-200 px-1 py-1.5 italic text-gray-600">${getDisp(w, 'mcMg')}</td>
              <td class="border border-gray-200 px-1 py-1.5 italic text-gray-800 font-medium">${getDisp(w, 'mcG')}</td>
              <td class="border border-gray-200 px-1 py-1.5 italic text-gray-600">${getDisp(w, 'mcKg')}</td>
              <td class="border border-gray-200 px-1 py-1.5 text-gray-500">${getDisp(w, 'uMg')}</td>
              <td class="border border-gray-200 px-1 py-1.5 text-indigo-600 font-medium">${getDisp(w, 'uG')}</td>
              <td class="border border-gray-200 px-1 py-1.5 text-gray-500">${getDisp(w, 'uKg')}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function toggleAllWeights(checked) {
    document.querySelectorAll('.weight-checkbox').forEach(cb => cb.checked = checked);
  }

  function confirmCalibratorSelection(setId) {
    const set = masterBatuData.find(d => d.id === setId);
    if (!set) return;

    const selectedIndices = Array.from(document.querySelectorAll('.weight-checkbox:checked')).map(cb => parseInt(cb.value));
    if (selectedIndices.length === 0) {
      alert("Pilih minimal satu item batu timbang.");
      return;
    }

    const selectedWeights = selectedIndices.map(idx => set.weights[idx]);
    const rowIdx = currentLookupTarget.elementId.split('-').pop();

    document.getElementById(`calib-id-${rowIdx}`).value = set.id;
    document.getElementById(`calib-inst-${rowIdx}`).value = set.merek || "-";
    document.getElementById(`calib-cert-${rowIdx}`).value = set.sertifikat || "-";

    // Helper to get raw numeric nominal and display string
    const getWeightInfo = (w) => {
      // New format check
      if (w.nomG && w.nomG !== "-") return { val: parseFloat(w.nomG.replace(',', '.')), unit: 'g', label: w.nomG };
      if (w.nomMg && w.nomMg !== "-") return { val: parseFloat(w.nomMg.replace(',', '.')) / 1000, unit: 'mg', label: w.nomMg };
      if (w.nomKg && w.nomKg !== "-") return { val: parseFloat(w.nomKg.replace(',', '.')) * 1000, unit: 'kg', label: w.nomKg };

      // Old format fallback
      const nom = parseFloat(w.nominal);
      const unit = w.unit || 'g';
      const factor = unit === 'kg' ? 1000 : (unit === 'mg' ? 0.001 : 1);
      return { val: nom * factor, unit: unit, label: `${w.nominal}${unit}` };
    };

    // Create label from selected items
    let nominalLabel = "";
    if (selectedWeights.length === set.weights.length) {
      const info = selectedWeights.map(getWeightInfo).sort((a, b) => a.val - b.val);
      const min = info[0];
      const max = info[info.length - 1];
      nominalLabel = `${min.label} - ${max.label}`;
    } else if (selectedWeights.length <= 5) {
      nominalLabel = selectedWeights.map(w => getWeightInfo(w).label).join(', ');
    } else {
      const info = selectedWeights.map(getWeightInfo).sort((a, b) => a.val - b.val);
      nominalLabel = `${info[0].label} .. ${info[info.length - 1].label} (${selectedWeights.length} pcs)`;
    }

    document.getElementById(`calib-nom-${rowIdx}`).value = nominalLabel;
    document.getElementById(`calib-class-${rowIdx}`).value = set.kelas || "-";

    if (typeof calculateUncertainty === 'function') calculateUncertainty();
    closeMasterLookup();
  }

  function selectWeightFromMaster(weightIdx) {
    const setId = document.getElementById('lookup-id-select').value;
    const set = masterBatuData.find(d => d.id === setId);
    if (!set) return;
    const w = set.weights[weightIdx];

    // Helper to extract nominal, MC, and U (prioritize matching current unit, ALWAYS internal grams)
    const getMasterValues = (w) => {
      let nomG = 0, mcG = 0, uG = 0;

      const units = [g_currentUnit, 'g', 'kg', 'mg'];
      const uniqueUnits = [...new Set(units)];

      // Find first available nominal
      for (const u of uniqueUnits) {
        const key = u === 'g' ? 'nomG' : (u === 'kg' ? 'nomKg' : 'nomMg');
        if (w[key] && w[key] !== "-") {
          const mult = u === 'kg' ? 1000 : (u === 'mg' ? 0.001 : 1);
          const rawVal = parseFloat(w[key].toString().replace(/\./g, "").replace(",", "."));
          nomG = rawVal * mult;
          break;
        }
      }
      if (nomG === 0) nomG = parseNumber(w.nominal || 0);

      // Find first available MC
      for (const u of uniqueUnits) {
        const key = u === 'g' ? 'mcG' : (u === 'kg' ? 'mcKg' : 'mcMg');
        if (w[key] && w[key] !== "-") {
          const mult = u === 'kg' ? 1000 : (u === 'mg' ? 0.001 : 1);
          const rawVal = parseFloat(w[key].toString().replace(/\./g, "").replace(",", "."));
          mcG = rawVal * mult;
          break;
        }
      }
      if (mcG === 0) mcG = parseNumber(w.mc || 0);

      // Find first available U
      for (const u of uniqueUnits) {
        const key = u === 'g' ? 'uG' : (u === 'kg' ? 'uKg' : 'uMg');
        if (w[key] && w[key] !== "-") {
          const mult = u === 'kg' ? 1000 : (u === 'mg' ? 0.001 : 1);
          const rawVal = parseFloat(w[key].toString().replace(/\./g, "").replace(",", "."));
          uG = rawVal * mult;
          break;
        }
      }
      if (uG === 0 && w.u && w.u !== "-") {
        uG = parseFloat(w.u.toString().replace(/\./g, "").replace(",", "."));
      }

      return { nomG, mcG, uG };
    };

    const vals = getMasterValues(w);


    if (currentLookupTarget.type === 'pre-adj') {
      const nomEl = document.getElementById('pre-adj-nominal');
      const mcEl = document.getElementById('pre-adj-mc');
      nomEl.dataset.baseWeight = vals.nomG;
      nomEl.classList.add('no-decimal');

      let mcDec = 9;
      if (g_currentUnit === 'g') mcDec = 6;
      else if (g_currentUnit === 'mg') mcDec = 3;

      const mcFormatted = formatNumber(vals.mcG, mcDec);
      mcEl.dataset.baseWeight = vals.mcG;
      mcEl.classList.add('mc-cell');
      mcEl.innerText = mcFormatted;
      refreshStaticWeights();
      if (typeof calculatePreAdjustment === 'function') calculatePreAdjustment();
    } else if (currentLookupTarget.type === 'post-adj') {
      const nomEl = document.getElementById('post-adj-nominal');
      const mcEl = document.getElementById('post-adj-mc');
      nomEl.dataset.baseWeight = vals.nomG;
      nomEl.classList.add('no-decimal');

      let mcDec = 9;
      if (g_currentUnit === 'g') mcDec = 6;
      else if (g_currentUnit === 'mg') mcDec = 3;

      const mcFormatted = formatNumber(vals.mcG, mcDec);
      mcEl.dataset.baseWeight = vals.mcG;
      mcEl.classList.add('mc-cell');
      mcEl.innerText = mcFormatted;
      refreshStaticWeights();
      if (typeof calculatePostAdjustment === 'function') calculatePostAdjustment();
    } else if (currentLookupTarget.type === 'linearity') {
      const tr = document.getElementById(currentLookupTarget.elementId);
      const nomCell = tr.cells[1];
      const mcCell = tr.cells[2];

      const nomSpan = nomCell.querySelector('span.no-decimal');
      if (nomSpan) {
        nomSpan.dataset.baseWeight = vals.nomG;
      } else {
        // Fallback if span not found (shouldn't happen with new HTML)
        nomCell.dataset.baseWeight = vals.nomG;
        nomCell.classList.add('no-decimal');
      }

      let mcDec = 9;
      if (g_currentUnit === 'g') mcDec = 6;
      else if (g_currentUnit === 'mg') mcDec = 3;

      const mcFormatted = formatNumber(vals.mcG, mcDec);
      mcCell.dataset.baseWeight = vals.mcG;
      mcCell.classList.add('mc-cell');
      mcCell.innerText = mcFormatted;

      // New: Store uncertainty for U1 calculation
      tr.dataset.certU = vals.uG;

      refreshStaticWeights();

      // Store kelas for U4 calculation (MPE lookup)
      if (set.kelas) tr.dataset.certKelas = set.kelas;

      const firstInput = tr.querySelector('input:not([readonly])');
      if (firstInput) firstInput.dispatchEvent(new Event('input', { bubbles: true }));
    } else if (currentLookupTarget.type === 'manual-input') {
      // Delegate to the manual input handler
      selectWeightForManualInput(weightIdx);
      return; // Don't close modal here, it's handled in selectWeightForManualInput
    } else if (currentLookupTarget.type === 'support-row') {
      const rowId = currentLookupTarget.elementId;
      const tr = document.getElementById(rowId);

      if (tr) {
        const idx = rowId.replace('support-row-', '');
        const idInput = document.getElementById(`support-id-${idx}`);
        const certInput = document.getElementById(`support-cert-${idx}`);
        const classInput = document.getElementById(`support-class-${idx}`);

        if (idInput) {
          idInput.value = set.id;
          // Trigger change event to populate other fields (dates, etc)
          idInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
        if (certInput) certInput.value = set.sertifikat || '';
        if (classInput) classInput.value = set.kelas || '';

        // Force save
        saveSupportData();
      }
      closeMasterLookup();
      return;
    }

    closeMasterLookup();
  }

  // Manual Input Modal Functions - Dual Weight Selection
  let manualInputWeights = { weight1: null, weight2: null };
  let manualInputTargetField = null;
  let manualInputTargetRow = null; // Track which row opened the modal

  function openManualInputModal(rowId) {
    // Store which row opened the modal
    manualInputTargetRow = rowId || null;

    // Reset selections
    manualInputWeights = { weight1: null, weight2: null };
    document.getElementById('manual-weight1-display').innerHTML = '<span class="text-gray-500">Klik untuk pilih batu timbang...</span>';
    document.getElementById('manual-weight2-display').innerHTML = '<span class="text-gray-500">Klik untuk pilih batu timbang...</span>';
    document.getElementById('manual-result-nominal').textContent = '-';
    document.getElementById('manual-formula-nominal').textContent = '';
    document.getElementById('manual-result-mc').textContent = '-';
    document.getElementById('manual-formula-mc').textContent = '';
    document.getElementById('manual-submit-btn').disabled = true;

    document.getElementById('modal-manual-input').classList.remove('hidden');
  }

  // Wrapper function for event-based calls
  function openManualInputModalWithRow(event) {
    const button = event.target.closest('button');
    const cell = button.closest('td');
    const row = cell.closest('tr');
    const rowId = row ? row.id : null;
    openManualInputModal(rowId);
  }

  function closeManualInputModal() {
    document.getElementById('modal-manual-input').classList.add('hidden');
  }

  function openMasterLookupForManual(fieldNumber) {
    manualInputTargetField = fieldNumber;

    // Hide the manual input modal temporarily to show master lookup modal
    document.getElementById('modal-manual-input').classList.add('hidden');

    // Temporarily set the lookup target to 'manual-input'
    const originalTarget = currentLookupTarget;
    currentLookupTarget = { type: 'manual-input', fieldNumber: fieldNumber };

    // Open the master lookup modal
    masterBatuData = getValidMasterData();
    const allMasterTotal = JSON.parse(localStorage.getItem('masterBatuTimbang') || '[]');

    if (allMasterTotal.length === 0) {
      alert('Data Master Batu Timbang belum ada. Silakan isi di menu Master Data.');
      currentLookupTarget = originalTarget;
      // Restore manual input modal
      document.getElementById('modal-manual-input').classList.remove('hidden');
      return;
    }

    if (masterBatuData.length === 0) {
      alert('Tidak ada Data Master yang cocok dengan ID di "DATA BATU TIMBANG YANG DIGUNAKAN".\\nSilakan isi tabel 1B terlebih dahulu.');
      currentLookupTarget = originalTarget;
      // Restore manual input modal
      document.getElementById('modal-manual-input').classList.remove('hidden');
      return;
    }

    const select = document.getElementById('lookup-id-select');
    const currentValue = select.value;
    select.innerHTML = '<option value="">Pilih ID Batu Timbang...</option>' +
      masterBatuData.map(d => '<option value="' + d.id + '"' + (d.id === currentValue ? ' selected' : '') + '>' + d.id + ' (' + d.sertifikat + ')</option>').join('');

    document.getElementById('modal-master-lookup').classList.remove('hidden');
    renderLookupWeights();
  }

  function selectWeightForManualInput(weightIdx) {
    const setId = document.getElementById('lookup-id-select').value;
    const set = masterBatuData.find(d => d.id === setId);
    if (!set) return;
    const w = set.weights[weightIdx];

    // Get nominal and Mc values in grams
    const getMasterValues = (w) => {
      let nomG = 0, mcG = 0, uG = 0;
      const units = [g_currentUnit, 'g', 'kg', 'mg'];
      const uniqueUnits = [...new Set(units)];

      // Find nominal
      for (const u of uniqueUnits) {
        const key = u === 'g' ? 'nomG' : (u === 'kg' ? 'nomKg' : 'nomMg');
        if (w[key] && w[key] !== "-") {
          const mult = u === 'kg' ? 1000 : (u === 'mg' ? 0.001 : 1);
          nomG = parseNumber(w[key]) * mult;
          break;
        }
      }
      if (nomG === 0) nomG = parseNumber(w.nominal || 0);

      // Find Mc
      for (const u of uniqueUnits) {
        const key = u === 'g' ? 'mcG' : (u === 'kg' ? 'mcKg' : 'mcMg');
        if (w[key] && w[key] !== "-") {
          const mult = u === 'kg' ? 1000 : (u === 'mg' ? 0.001 : 1);
          mcG = parseNumber(w[key]) * mult;
          break;
        }
      }
      if (mcG === 0) mcG = parseNumber(w.mc || 0);

      // Find U
      for (const u of uniqueUnits) {
        const key = u === 'g' ? 'uG' : (u === 'kg' ? 'uKg' : 'uMg');
        if (w[key] && w[key] !== "-") {
          const mult = u === 'kg' ? 1000 : (u === 'mg' ? 0.001 : 1);
          const rawVal = parseFloat(w[key].toString().replace(/\./g, "").replace(",", "."));
          uG = rawVal * mult;
          break;
        }
      }
      if (uG === 0 && w.u && w.u !== "-") {
        uG = parseFloat(w.u.toString().replace(/\./g, "").replace(",", "."));
      }

      return { nomG, mcG, uG, kelas: w.kelas };
    };

    const vals = getMasterValues(w);
    const fieldNumber = currentLookupTarget.fieldNumber;

    // Store the weight data with both nominal and Mc
    if (fieldNumber === 1) {
      manualInputWeights.weight1 = {
        nominal: vals.nomG,
        mc: vals.mcG,
        u: vals.uG,
        kelas: vals.kelas,
        label: formatNumber(vals.nomG, 0) + ' g'
      };
      document.getElementById('manual-weight1-display').innerHTML =
        '<span class="font-semibold text-indigo-700">' + manualInputWeights.weight1.label + '</span>';
    } else {
      manualInputWeights.weight2 = {
        nominal: vals.nomG,
        mc: vals.mcG,
        u: vals.uG,
        kelas: vals.kelas,
        label: formatNumber(vals.nomG, 0) + ' g'
      };
      document.getElementById('manual-weight2-display').innerHTML =
        '<span class="font-semibold text-indigo-700">' + manualInputWeights.weight2.label + '</span>';
    }

    // Auto-calculate if both weights are selected
    if (manualInputWeights.weight1 && manualInputWeights.weight2) {
      calculateManualResult();
    }

    closeMasterLookup();

    // Restore the manual input modal after closing master lookup
    document.getElementById('modal-manual-input').classList.remove('hidden');
  }

  function calculateManualResult() {
    if (!manualInputWeights.weight1 || !manualInputWeights.weight2) {
      return;
    }

    // Calculate: Nominal1 + Nominal2
    const nominalResult = manualInputWeights.weight1.nominal + manualInputWeights.weight2.nominal;

    // Calculate: Mc1 + Mc2
    const mcResult = manualInputWeights.weight1.mc + manualInputWeights.weight2.mc;

    // Determine decimal precision for Mc based on current unit
    let mcDec = 9;
    if (g_currentUnit === 'g') mcDec = 6;
    else if (g_currentUnit === 'mg') mcDec = 3;

    // Display Nominal result
    document.getElementById('manual-result-nominal').textContent = formatNumber(nominalResult, 0) + ' g';
    document.getElementById('manual-formula-nominal').textContent =
      manualInputWeights.weight1.label + ' + ' + manualInputWeights.weight2.label + ' = ' + formatNumber(nominalResult, 0) + ' g';

    // Display Mc result
    document.getElementById('manual-result-mc').textContent = formatNumber(mcResult, mcDec) + ' g';
    document.getElementById('manual-formula-mc').textContent =
      formatNumber(manualInputWeights.weight1.mc, mcDec) + ' g + ' +
      formatNumber(manualInputWeights.weight2.mc, mcDec) + ' g = ' +
      formatNumber(mcResult, mcDec) + ' g';

    // New: Handle Uncertainty Summation
    const uResult = manualInputWeights.weight1.u + manualInputWeights.weight2.u;
    const uLabel = document.getElementById('manual-result-u');
    const uFormula = document.getElementById('manual-formula-u');
    if (uLabel && uFormula) {
      uLabel.textContent = formatNumber(uResult, 9) + ' g';
      uFormula.textContent = formatNumber(manualInputWeights.weight1.u, 9) + ' g + ' +
        formatNumber(manualInputWeights.weight2.u, 9) + ' g = ' +
        formatNumber(uResult, 9) + ' g';
    }

    // Enable submit button
    document.getElementById('manual-submit-btn').disabled = false;
  }

  function submitManualInput() {
    if (!manualInputWeights.weight1 || !manualInputWeights.weight2) {
      alert('Silakan pilih kedua batu timbang terlebih dahulu');
      return;
    }

    if (!manualInputTargetRow) {
      alert('Row target tidak ditemukan');
      return;
    }

    const tr = document.getElementById(manualInputTargetRow);
    if (!tr) {
      alert('Baris tabel tidak ditemukan');
      return;
    }

    // Calculate combined values
    const nominalResultG = manualInputWeights.weight1.nominal + manualInputWeights.weight2.nominal;
    const mcResultG = manualInputWeights.weight1.mc + manualInputWeights.weight2.mc;
    const uResultG = manualInputWeights.weight1.u + manualInputWeights.weight2.u;

    // Get table cells (assuming column structure: No, Nominal, Mc, ...)
    const nomCell = tr.cells[1]; // Column 2: Nominal Batu Timbang
    const mcCell = tr.cells[2];  // Column 3: Massa Konvensional

    // Update Nominal cell
    const nomSpan = nomCell.querySelector('span.no-decimal');
    if (nomSpan) {
      nomSpan.dataset.baseWeight = nominalResultG;
    } else {
      nomCell.dataset.baseWeight = nominalResultG;
      nomCell.classList.add('no-decimal');
    }

    // Update Mc cell
    let mcDec = 9;
    if (g_currentUnit === 'g') mcDec = 6;
    else if (g_currentUnit === 'mg') mcDec = 3;

    const mcFormatted = formatNumber(mcResultG, mcDec);
    mcCell.dataset.baseWeight = mcResultG;
    mcCell.classList.add('mc-cell');
    mcCell.innerText = mcFormatted;

    // New: Store uncertainty for U1 calculation
    tr.dataset.certU = uResultG;

    // Capture class for U4 calculation
    // If weights have different classes, we'll take the first one (most likely same)
    if (manualInputWeights.weight1.kelas) {
      tr.dataset.certKelas = manualInputWeights.weight1.kelas;
    }

    // Refresh display to respect current unit
    refreshStaticWeights();

    // Trigger recalculation if there's input in the row
    const firstInput = tr.querySelector('input:not([readonly])');
    if (firstInput) firstInput.dispatchEvent(new Event('input', { bubbles: true }));

    // Close modal and notify user
    closeManualInputModal();
    alert('Nilai berhasil dimasukkan ke baris ' + manualInputTargetRow);
  }
</script>